package com.microsoft.ads.data.dnv.agg_dw_clicks_pb.graph

import io.prophecy.libs._
import com.microsoft.ads.data.dnv.agg_dw_clicks_pb.udfs.PipelineInitCode._
import com.microsoft.ads.data.dnv.agg_dw_clicks_pb.udfs.UDFs._
import com.microsoft.ads.data.dnv.agg_dw_clicks_pb.udfs.ColumnFunctions._
import com.microsoft.ads.data.dnv.agg_dw_clicks_pb.config.Context
import org.apache.spark._
import org.apache.spark.sql._
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types._
import org.apache.spark.sql.expressions._
import java.time._

object Join_aggDwClicksPb_AddLookupResults {

  def apply(context: Context, in: DataFrame): DataFrame =
    in.withColumn(
        "booked_revenue_dollars",
        when(
          col("ll1_imp_type") =!= lit(6),
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("booked_revenue_dollars")
        ).otherwise(
          when(
            f_clicks_pass_through_financials(
              col("ll2_auction_event_pricing"),
              col("ll0_revenue_info"),
              col("ll1_imp_type"),
              col("ll1_payment_type"),
              col("ll1_revenue_type"),
              col("ll1_media_buy_rev_share_pct"),
              col("ll1_commission_revshare"),
              col("ll1_serving_fees_revshare"),
              coalesce(col("_lkp_sales_tax_rate_LOOKUP").getField(
                         "sales_tax_rate_pct"
                       ),
                       lit(0.0d)
              )
            ).getField("seller_transacted").cast(BooleanType),
            lit(0.001d) * f_clicks_pass_through_financials(
              col("ll2_auction_event_pricing"),
              col("ll0_revenue_info"),
              col("ll1_imp_type"),
              col("ll1_payment_type"),
              col("ll1_revenue_type"),
              col("ll1_media_buy_rev_share_pct"),
              col("ll1_commission_revshare"),
              col("ll1_serving_fees_revshare"),
              coalesce(col("_lkp_sales_tax_rate_LOOKUP").getField(
                         "sales_tax_rate_pct"
                       ),
                       lit(0.0d)
              )
            ).getField("seller_revenue")
          )
        )
      )
      .withColumn(
        "total_data_costs_microcents",
        f_clicks_pass_through_financials(
          col("ll2_auction_event_pricing"),
          col("ll0_revenue_info"),
          col("ll1_imp_type"),
          col("ll1_payment_type"),
          col("ll1_revenue_type"),
          col("ll1_media_buy_rev_share_pct"),
          col("ll1_commission_revshare"),
          col("ll1_serving_fees_revshare"),
          coalesce(
            col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
            lit(0.0d)
          )
        ).getField("total_data_costs_microcents")
      )
      .withColumn(
        "total_segment_data_costs_microcents",
        when(
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("is_buy_side_imp").cast(BooleanType),
          coalesce(col("ll0_revenue_info.total_segment_data_costs_microcents"),
                   lit(0)
          )
        ).otherwise(lit(0))
      )
      .withColumn(
        "media_cost_dollars_cpm",
        f_clicks_pass_through_financials(
          col("ll2_auction_event_pricing"),
          col("ll0_revenue_info"),
          col("ll1_imp_type"),
          col("ll1_payment_type"),
          col("ll1_revenue_type"),
          col("ll1_media_buy_rev_share_pct"),
          col("ll1_commission_revshare"),
          col("ll1_serving_fees_revshare"),
          coalesce(
            col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
            lit(0.0d)
          )
        ).getField("media_cost_dollar_cpm")
      )
      .withColumn(
        "data_costs",
        f_update_data_costs(
          col("ll1_data_costs"),
          col("ll1_imp_type"),
          lit(1),
          col("ll1_payment_type"),
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("media_cost_dollar_cpm"),
          coalesce(
            col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
            lit(0.0d)
          )
        )
      )
      .withColumn(
        "buyer_charges",
        when(
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("buyer_transacted").cast(BooleanType),
          f_update_charge_terms(col("ll2_auction_event_pricing.buyer_charges"),
                                col("ll1_buyer_charges")
          )
        ).otherwise(f_zero_out_pricing_terms(col("ll1_buyer_charges")))
      )
      .withColumn(
        "auction_service_deduction",
        when(
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("buyer_transacted")
            .cast(BooleanType)
            .and(
              f_clicks_pass_through_financials(
                col("ll2_auction_event_pricing"),
                col("ll0_revenue_info"),
                col("ll1_imp_type"),
                col("ll1_payment_type"),
                col("ll1_revenue_type"),
                col("ll1_media_buy_rev_share_pct"),
                col("ll1_commission_revshare"),
                col("ll1_serving_fees_revshare"),
                coalesce(col("_lkp_sales_tax_rate_LOOKUP").getField(
                           "sales_tax_rate_pct"
                         ),
                         lit(0.0d)
                )
              ).getField("is_buy_side_imp").cast(BooleanType)
            ),
          lit(0.001d) * f_get_auction_events_pricing_terms_for_term_id(
            col("ll2_auction_event_pricing.buyer_charges.pricing_terms"),
            lit(1),
            lit(1)
          )
        )
      )
      .withColumn(
        "booked_revenue_adv_curr",
        when(
          col("ll1_imp_type") =!= lit(6),
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("booked_revenue_adv_curr")
        ).otherwise(
          when(
            f_clicks_pass_through_financials(
              col("ll2_auction_event_pricing"),
              col("ll0_revenue_info"),
              col("ll1_imp_type"),
              col("ll1_payment_type"),
              col("ll1_revenue_type"),
              col("ll1_media_buy_rev_share_pct"),
              col("ll1_commission_revshare"),
              col("ll1_serving_fees_revshare"),
              coalesce(col("_lkp_sales_tax_rate_LOOKUP").getField(
                         "sales_tax_rate_pct"
                       ),
                       lit(0.0d)
              )
            ).getField("seller_transacted").cast(BooleanType),
            lit(0.001d) * (f_clicks_pass_through_financials(
              col("ll2_auction_event_pricing"),
              col("ll0_revenue_info"),
              col("ll1_imp_type"),
              col("ll1_payment_type"),
              col("ll1_revenue_type"),
              col("ll1_media_buy_rev_share_pct"),
              col("ll1_commission_revshare"),
              col("ll1_serving_fees_revshare"),
              coalesce(col("_lkp_sales_tax_rate_LOOKUP").getField(
                         "sales_tax_rate_pct"
                       ),
                       lit(0.0d)
              )
            ).getField("seller_revenue") * col("ll1_publisher_exchange_rate"))
          )
        )
      )
      .withColumn(
        "net_media_cost_dollars_cpm",
        when(
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("buyer_transacted").cast(BooleanType),
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("net_media_cost_dollar_cpm")
        )
      )
      .withColumn(
        "total_partner_fees_microcents",
        f_clicks_pass_through_financials(
          col("ll2_auction_event_pricing"),
          col("ll0_revenue_info"),
          col("ll1_imp_type"),
          col("ll1_payment_type"),
          col("ll1_revenue_type"),
          col("ll1_media_buy_rev_share_pct"),
          col("ll1_commission_revshare"),
          col("ll1_serving_fees_revshare"),
          coalesce(
            col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
            lit(0.0d)
          )
        ).getField("total_partner_fees_microcents")
      )
      .withColumn(
        "auction_service_fees",
        when(
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("buyer_transacted")
            .cast(BooleanType)
            .and(
              f_clicks_pass_through_financials(
                col("ll2_auction_event_pricing"),
                col("ll0_revenue_info"),
                col("ll1_imp_type"),
                col("ll1_payment_type"),
                col("ll1_revenue_type"),
                col("ll1_media_buy_rev_share_pct"),
                col("ll1_commission_revshare"),
                col("ll1_serving_fees_revshare"),
                coalesce(col("_lkp_sales_tax_rate_LOOKUP")
                           .getField("sales_tax_rate_pct"),
                         lit(0.0d)
                )
              ).getField("is_buy_side_imp").cast(BooleanType)
            ),
          lit(0.001d) * f_get_auction_events_pricing_terms_for_term_id(
            col("ll2_auction_event_pricing.buyer_charges.pricing_terms"),
            lit(1),
            lit(0)
          )
        )
      )
      .withColumn(
        "seller_deduction",
        when(
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("seller_transacted")
            .cast(BooleanType)
            .and(
              f_clicks_pass_through_financials(
                col("ll2_auction_event_pricing"),
                col("ll0_revenue_info"),
                col("ll1_imp_type"),
                col("ll1_payment_type"),
                col("ll1_revenue_type"),
                col("ll1_media_buy_rev_share_pct"),
                col("ll1_commission_revshare"),
                col("ll1_serving_fees_revshare"),
                coalesce(col("_lkp_sales_tax_rate_LOOKUP")
                           .getField("sales_tax_rate_pct"),
                         lit(0.0d)
                )
              ).getField("is_sell_side_imp").cast(BooleanType)
            ),
          lit(0.001d) * (f_get_auction_events_pricing_terms_for_term_id(
            col("ll2_auction_event_pricing.seller_charges.pricing_terms"),
            lit(1),
            lit(1)
          ) + f_get_auction_events_pricing_terms_for_term_id(
            col("ll2_auction_event_pricing.seller_charges.pricing_terms"),
            lit(74),
            lit(1)
          ))
        )
      )
      .withColumn(
        "total_profit_microcents",
        f_clicks_pass_through_financials(
          col("ll2_auction_event_pricing"),
          col("ll0_revenue_info"),
          col("ll1_imp_type"),
          col("ll1_payment_type"),
          col("ll1_revenue_type"),
          col("ll1_media_buy_rev_share_pct"),
          col("ll1_commission_revshare"),
          col("ll1_serving_fees_revshare"),
          coalesce(
            col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
            lit(0.0d)
          )
        ).getField("total_profit_microcents")
      )
      .withColumn(
        "seller_charges",
        when(
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("seller_transacted").cast(BooleanType),
          f_update_charge_terms(col("ll2_auction_event_pricing.seller_charges"),
                                col("ll1_seller_charges")
          )
        ).otherwise(f_zero_out_pricing_terms(col("ll1_seller_charges")))
      )
      .withColumn(
        "total_feature_costs_microcents",
        when(
          f_clicks_pass_through_financials(
            col("ll2_auction_event_pricing"),
            col("ll0_revenue_info"),
            col("ll1_imp_type"),
            col("ll1_payment_type"),
            col("ll1_revenue_type"),
            col("ll1_media_buy_rev_share_pct"),
            col("ll1_commission_revshare"),
            col("ll1_serving_fees_revshare"),
            coalesce(
              col("_lkp_sales_tax_rate_LOOKUP").getField("sales_tax_rate_pct"),
              lit(0.0d)
            )
          ).getField("is_buy_side_imp").cast(BooleanType),
          coalesce(col("ll0_revenue_info.total_feature_costs_microcents"),
                   lit(0)
          )
        ).otherwise(lit(0))
      )

}
