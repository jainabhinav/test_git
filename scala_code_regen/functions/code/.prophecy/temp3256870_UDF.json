{"initCode":"","code":"udf((_l_filtered_terms: Seq[Row], _unfiltered_terms: Seq[Row], _i: Integer) => {\n  var l_current_term = Row(null, null, null, null, null, null)\nvar l_filtered_terms = (_l_filtered_terms).toArray\nvar i = _i\nvar unfiltered_terms = (_unfiltered_terms).toArray\n\nwhile(compareTo(i, unfiltered_terms.length) < 0) {\nl_current_term = unfiltered_terms(convertToInt(i))\nif(unfiltered_terms(convertToInt(i)).getAs[Boolean](\"is_deduction\") == convertToBoolean(0)){\nl_filtered_terms = Array.concat(l_filtered_terms,Array.fill(1)(unfiltered_terms(convertToInt(i))))\n}\ni = i + convertToInt(1)\n}\n\nRow(if (!_isnull(l_current_term)) {\n Row(convertToInt(l_current_term.get(0)), l_current_term.get(1), l_current_term.get(2), l_current_term.get(3), l_current_term.get(4), convertToInt(l_current_term.get(5)))\n} else {\n null\n}, l_filtered_terms.map{x => if (!_isnull(x)) {\n Row(convertToInt(x.get(0)), x.get(1), x.get(2), x.get(3), x.get(4), convertToInt(x.get(5)))\n} else {\n null\n}}.toArray, convertToInt(i))\n},  StructType(\n      List(\n      StructField(\"l_current_term\",  StructType(\n      List(\n      StructField(\"term_id\", IntegerType, true),StructField(\"amount\", DoubleType, true),StructField(\"rate\", DoubleType, true),StructField(\"is_deduction\", BooleanType, true),StructField(\"is_media_cost_dependent\", BooleanType, true),StructField(\"data_member_id\", IntegerType, true)\n      )\n    ), false),StructField(\"l_filtered_terms\", ArrayType( StructType(\n      List(\n      StructField(\"term_id\", IntegerType, true),StructField(\"amount\", DoubleType, true),StructField(\"rate\", DoubleType, true),StructField(\"is_deduction\", BooleanType, true),StructField(\"is_media_cost_dependent\", BooleanType, true),StructField(\"data_member_id\", IntegerType, true)\n      )\n    )), false),StructField(\"i\", IntegerType, false)\n      )\n    ))"}