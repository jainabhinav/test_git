package io.prophecy.pipelines.first_agg_platform_video_analytics.graph.Main_Graph

import io.prophecy.libs._
import io.prophecy.pipelines.first_agg_platform_video_analytics.udfs.PipelineInitCode._
import io.prophecy.pipelines.first_agg_platform_video_analytics.udfs.UDFs._
import io.prophecy.pipelines.first_agg_platform_video_analytics.udfs.ColumnFunctions._
import io.prophecy.pipelines.first_agg_platform_video_analytics.graph.Main_Graph.config.Context
import org.apache.spark._
import org.apache.spark.sql._
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types._
import org.apache.spark.sql.expressions._
import java.time._

object join_by_auction_id {

  def apply(context: Context, in0: DataFrame, in1: DataFrame): DataFrame =
    in0
      .as("in0")
      .join(in1.as("in1"),
            col("in0.auction_id_64") === col("in1.auction_id_64"),
            "left_outer"
      )
      .select(
        col("in0.auction_id_64").as("auction_id_64"),
        col("in0.date_time").as("date_time"),
        agg_platform_video_requests(context).as("agg_platform_video_requests"),
        agg_dw_video_events(context).as("agg_dw_video_events")
      )

  def agg_dw_video_events(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    when(
      is_not_null(col("in1.auction_id_64")).cast(BooleanType),
      struct(
        col("in1.date_time").as("date_time"),
        col("in1.auction_id_64").as("auction_id_64"),
        col("in1.buyer_member_id").as("buyer_member_id"),
        col("in1.seller_member_id").as("seller_member_id"),
        col("in1.advertiser_id").as("advertiser_id"),
        col("in1.publisher_id").as("publisher_id"),
        col("in1.site_id").as("site_id"),
        col("in1.tag_id").as("tag_id"),
        col("in1.insertion_order_id").as("insertion_order_id"),
        col("in1.campaign_group_id").as("campaign_group_id"),
        col("in1.campaign_id").as("campaign_id"),
        col("in1.creative_id").as("creative_id"),
        col("in1.creative_freq").as("creative_freq"),
        col("in1.creative_rec").as("creative_rec"),
        col("in1.brand_id").as("brand_id"),
        col("in1.geo_country").as("geo_country"),
        col("in1.width").as("width"),
        col("in1.height").as("height"),
        col("in1.deal_id").as("deal_id"),
        col("in1.video_was_served").as("video_was_served"),
        col("in1.video_started").as("video_started"),
        col("in1.video_was_skipped").as("video_was_skipped"),
        col("in1.video_had_error").as("video_had_error"),
        col("in1.video_hit_25_pct").as("video_hit_25_pct"),
        col("in1.video_hit_50_pct").as("video_hit_50_pct"),
        col("in1.video_hit_75_pct").as("video_hit_75_pct"),
        col("in1.video_completed").as("video_completed"),
        col("in1.imp_type").as("imp_type"),
        col("in1.advertiser_currency").as("advertiser_currency"),
        col("in1.publisher_currency").as("publisher_currency"),
        col("in1.site_domain").as("site_domain"),
        col("in1.application_id").as("application_id"),
        col("in1.media_cost_dollars_cpm").as("media_cost_dollars_cpm"),
        col("in1.booked_revenue_dollars").as("booked_revenue_dollars"),
        col("in1.seller_revenue_cpm").as("seller_revenue_cpm"),
        col("in1.vp_bitmap").as("vp_bitmap"),
        col("in1.buyer_currency").as("buyer_currency"),
        col("in1.is_learn").as("is_learn"),
        col("in1.external_inv_id").as("external_inv_id"),
        col("in1.pub_rule_id").as("pub_rule_id"),
        col("in1.predict_type_rev").as("predict_type_rev"),
        col("in1.predict_type_goal").as("predict_type_goal"),
        col("in1.media_type").as("media_type"),
        col("in1.venue_id").as("venue_id"),
        col("in1.payment_type").as("payment_type"),
        col("in1.revenue_type").as("revenue_type"),
        col("in1.viewdef_definition_id").as("viewdef_definition_id"),
        col("in1.advertiser_exchange_rate").as("advertiser_exchange_rate"),
        col("in1.publisher_exchange_rate").as("publisher_exchange_rate"),
        col("in1.vp_expose_pubs").as("vp_expose_pubs"),
        col("in1.vp_expose_tag").as("vp_expose_tag"),
        col("in1.vp_expose_categories").as("vp_expose_categories"),
        col("in1.playback_method").as("playback_method"),
        col("in1.video_context").as("video_context"),
        col("in1.player_size_id").as("player_size_id"),
        col("in1.supply_type").as("supply_type"),
        col("in1.vp_expose_domains").as("vp_expose_domains"),
        col("in1.view_result").as("view_result"),
        col("in1.view_non_measurable_reason").as("view_non_measurable_reason"),
        col("in1.error_code").as("error_code"),
        col("in1.request_imp_type").as("request_imp_type"),
        col("in1.call_type").as("call_type"),
        col("in1.companion_creative_id").as("companion_creative_id"),
        col("in1.companion_imps").as("companion_imps"),
        col("in1.companion_clicks").as("companion_clicks"),
        col("in1.user_id_64").as("user_id_64"),
        col("in1.geo_region").as("geo_region"),
        col("in1.gender").as("gender"),
        col("in1.age").as("age"),
        col("in1.operating_system").as("operating_system"),
        col("in1.browser").as("browser"),
        col("in1.language").as("language"),
        col("in1.latitude").as("latitude"),
        col("in1.longitude").as("longitude"),
        col("in1.device_id").as("device_id"),
        col("in1.carrier_id").as("carrier_id"),
        col("in1.device_type").as("device_type"),
        col("in1.dma").as("dma"),
        col("in1.postal").as("postal"),
        col("in1.city").as("city"),
        col("in1.request_uuid").as("request_uuid"),
        col("in1.tag_sizes").as("tag_sizes"),
        col("in1.user_tz_offset").as("user_tz_offset"),
        col("in1.fold_position").as("fold_position"),
        col("in1.anonymized_user_info").as("anonymized_user_info"),
        col("in1.personal_data").as("personal_data"),
        col("in1.inventory_url_id").as("inventory_url_id"),
        col("in1.predicted_100pd_video_completion_rate")
          .as("predicted_100pd_video_completion_rate"),
        col("in1.inventory_source_id").as("inventory_source_id"),
        col("in1.session_frequency").as("session_frequency"),
        col("in1.is_control").as("is_control"),
        col("in1.device_unique_id").as("device_unique_id"),
        col("in1.targeted_segments").as("targeted_segments"),
        col("in1.seller_currency").as("seller_currency"),
        col("in1.is_toolbar").as("is_toolbar"),
        col("in1.control_pct").as("control_pct"),
        col("in1.advertiser_frequency").as("advertiser_frequency"),
        col("in1.advertiser_recency").as("advertiser_recency"),
        col("in1.ozone_id").as("ozone_id"),
        col("in1.is_performance").as("is_performance"),
        col("in1.sdk_version").as("sdk_version"),
        col("in1.media_buy_id").as("media_buy_id"),
        col("in1.camp_dp_id").as("camp_dp_id"),
        col("in1.user_group_id").as("user_group_id"),
        col("in1.package_id").as("package_id"),
        col("in1.campaign_group_freq").as("campaign_group_freq"),
        col("in1.campaign_group_rec").as("campaign_group_rec"),
        col("in1.insertion_order_freq").as("insertion_order_freq"),
        col("in1.insertion_order_rec").as("insertion_order_rec"),
        col("in1.buyer_gender").as("buyer_gender"),
        col("in1.buyer_age").as("buyer_age"),
        col("in1.targeted_segment_list").as("targeted_segment_list"),
        col("in1.custom_model_id").as("custom_model_id"),
        col("in1.custom_model_last_modified").as("custom_model_last_modified"),
        col("in1.custom_model_output_code").as("custom_model_output_code"),
        col("in1.external_uid").as("external_uid"),
        col("in1.is_remarketing").as("is_remarketing"),
        col("in1.mobile_app_instance_id").as("mobile_app_instance_id"),
        col("in1.traffic_source_code").as("traffic_source_code"),
        col("in1.external_request_id").as("external_request_id"),
        col("in1.stitch_group_id").as("stitch_group_id"),
        col("in1.deal_type").as("deal_type"),
        col("in1.ym_floor_id").as("ym_floor_id"),
        col("in1.ym_bias_id").as("ym_bias_id"),
        col("in1.bid_priority").as("bid_priority"),
        col("in1.pricing_type").as("pricing_type"),
        col("in1.buyer_charges").as("buyer_charges"),
        col("in1.seller_charges").as("seller_charges"),
        col("in1.revenue_value").as("revenue_value"),
        col("in1.media_buy_rev_share_pct").as("media_buy_rev_share_pct"),
        col("in1.view_detection_enabled").as("view_detection_enabled"),
        col("in1.data_costs").as("data_costs"),
        col("in1.device_make_id").as("device_make_id"),
        col("in1.operating_system_family_id").as("operating_system_family_id"),
        col("in1.pricing_media_type").as("pricing_media_type"),
        col("in1.buyer_trx_event_id").as("buyer_trx_event_id"),
        col("in1.seller_trx_event_id").as("seller_trx_event_id"),
        col("in1.is_unit_of_trx").as("is_unit_of_trx"),
        col("in1.revenue_auction_event_type").as("revenue_auction_event_type"),
        col("in1.is_prebid").as("is_prebid"),
        col("in1.auction_timestamp").as("auction_timestamp"),
        col("in1.clear_fees").as("clear_fees"),
        col("in1.is_appnexus_cleared").as("is_appnexus_cleared"),
        col("in1.two_phase_reduction_applied")
          .as("two_phase_reduction_applied"),
        col("in1.region_id").as("region_id"),
        col("in1.media_company_id").as("media_company_id"),
        col("in1.trade_agreement_id").as("trade_agreement_id"),
        col("in1.cadence_modifier").as("cadence_modifier"),
        col("in1.content_category_id").as("content_category_id"),
        col("in1.fx_rate_snapshot_id").as("fx_rate_snapshot_id"),
        col("in1.crossdevice_group_anon").as("crossdevice_group_anon"),
        col("in1.revenue_event_type_id").as("revenue_event_type_id"),
        col("in1.inv_code").as("inv_code"),
        col("in1.bidder_id").as("bidder_id"),
        col("in1.serving_fees_revshare").as("serving_fees_revshare"),
        col("in1.commission_revshare").as("commission_revshare"),
        col("in1.booked_revenue_adv_curr").as("booked_revenue_adv_curr"),
        col("in1.predict_type_cost").as("predict_type_cost"),
        col("in1.ip_address").as("ip_address"),
        col("in1.predict_goal").as("predict_goal"),
        col("in1.seller_deduction").as("seller_deduction"),
        col("in1.auction_service_fees").as("auction_service_fees"),
        col("in1.auction_service_deduction").as("auction_service_deduction"),
        col("in1.is_creative_hosted").as("is_creative_hosted"),
        col("in1.creative_audit_status").as("creative_audit_status"),
        col("in1.datacenter_id").as("datacenter_id"),
        col("in1.truncate_ip").as("truncate_ip"),
        col("in1.is_exclusive").as("is_exclusive"),
        col("in1.vp_expose_gender").as("vp_expose_gender"),
        col("in1.vp_expose_age").as("vp_expose_age"),
        col("in1.crossdevice_graph_cost").as("crossdevice_graph_cost"),
        col("in1.player_width").as("player_width"),
        col("in1.player_height").as("player_height"),
        col("in1.external_creative_id").as("external_creative_id"),
        col("in1.age_bucket").as("age_bucket"),
        col("in1.bidder_seat_id").as("bidder_seat_id"),
        col("in1.billing_period_id").as("billing_period_id"),
        col("in1.flight_id").as("flight_id"),
        col("in1.split_id").as("split_id"),
        col("in1.total_partner_fees_microcents")
          .as("total_partner_fees_microcents"),
        col("in1.net_media_cost_dollars_cpm").as("net_media_cost_dollars_cpm"),
        col("in1.total_data_costs_microcents")
          .as("total_data_costs_microcents"),
        col("in1.total_profit_microcents").as("total_profit_microcents"),
        col("in1.curator_member_id").as("curator_member_id"),
        col("in1.eap").as("eap"),
        col("in1.ecp").as("ecp"),
        col("in1.buyer_bid").as("buyer_bid"),
        col("in1.reserve_price").as("reserve_price"),
        col("in1.serving_fees_cpm").as("serving_fees_cpm"),
        col("in1.can_convert").as("can_convert"),
        col("in1.control_creative_id").as("control_creative_id"),
        col("in1.commission_cpm").as("commission_cpm"),
        col("in1.creative_overage_fees").as("creative_overage_fees"),
        col("in1.imps_for_budget_caps_pacing")
          .as("imps_for_budget_caps_pacing"),
        col("in1.buyer_spend").as("buyer_spend"),
        col("in1.actual_bid").as("actual_bid"),
        col("in1.campaign_group_type_id").as("campaign_group_type_id"),
        col("in1.predicted_kpi_event_rate").as("predicted_kpi_event_rate"),
        col("in1.total_segment_data_costs_microcents")
          .as("total_segment_data_costs_microcents"),
        col("in1.total_feature_costs_microcents")
          .as("total_feature_costs_microcents"),
        col("in1.counterparty_ruleset_type").as("counterparty_ruleset_type"),
        col("in1.log_product_ads").as("log_product_ads"),
        col("in1.hb_source").as("hb_source"),
        col("in1.buyer_line_item_currency").as("buyer_line_item_currency"),
        col("in1.deal_line_item_currency").as("deal_line_item_currency"),
        col("in1.is_curated").as("is_curated"),
        col("in1.personal_identifiers_experimental")
          .as("personal_identifiers_experimental"),
        col("in1.postal_code_ext_id").as("postal_code_ext_id"),
        col("in1.ecpm_conversion_rate").as("ecpm_conversion_rate"),
        col("in1.targeted_segment_details_by_id_type")
          .as("targeted_segment_details_by_id_type"),
        col("in1.targeted_segment_details").as("targeted_segment_details"),
        col("in1.personal_identifiers").as("personal_identifiers"),
        col("in1.district_postal_code_lists").as("district_postal_code_lists"),
        col("in1.video_served_timestamp").as("video_served_timestamp"),
        col("in1.video_started_timestamp").as("video_started_timestamp"),
        col("in1.video_skipped_timestamp").as("video_skipped_timestamp"),
        col("in1.video_errored_timestamp").as("video_errored_timestamp"),
        col("in1.video_hit_25_pct_timestamp").as("video_hit_25_pct_timestamp"),
        col("in1.video_hit_50_pct_timestamp").as("video_hit_50_pct_timestamp"),
        col("in1.video_hit_75_pct_timestamp").as("video_hit_75_pct_timestamp"),
        col("in1.video_completed_timestamp").as("video_completed_timestamp"),
        col("in1.fallback_ad_index").as("fallback_ad_index"),
        col("in1.is_transacted").as("is_transacted"),
        col("in1.is_winning_events").as("is_winning_events"),
        col("in1.is_service_events").as("is_service_events"),
        col("in1.buyer_dpvp_bitmap").as("buyer_dpvp_bitmap"),
        col("in1.seller_dpvp_bitmap").as("seller_dpvp_bitmap"),
        col("in1.imp_media_cost_dollars_cpm").as("imp_media_cost_dollars_cpm"),
        col("in1.imp_booked_revenue_dollars").as("imp_booked_revenue_dollars"),
        col("in1.imp_seller_revenue_cpm").as("imp_seller_revenue_cpm")
      )
    )
  }

  def agg_platform_video_requests(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    when(
      is_not_null(col("in0.auction_id_64")).cast(BooleanType),
      struct(
        col("in0.date_time").as("date_time"),
        col("in0.auction_id_64").as("auction_id_64"),
        col("in0.tag_id").as("tag_id"),
        col("in0.width").as("width"),
        col("in0.height").as("height"),
        col("in0.geo_country").as("geo_country"),
        col("in0.geo_region").as("geo_region"),
        col("in0.seller_member_id").as("seller_member_id"),
        col("in0.imp_blacklist_or_fraud").as("imp_blacklist_or_fraud"),
        col("in0.call_type").as("call_type"),
        col("in0.brand_id").as("brand_id"),
        col("in0.imp_type").as("imp_type"),
        col("in0.publisher_id").as("publisher_id"),
        col("in0.site_id").as("site_id"),
        col("in0.content_category_id").as("content_category_id"),
        col("in0.media_type").as("media_type"),
        col("in0.browser").as("browser"),
        col("in0.language").as("language"),
        col("in0.application_id").as("application_id"),
        col("in0.city").as("city"),
        col("in0.supply_type").as("supply_type"),
        col("in0.deal_id").as("deal_id"),
        col("in0.vp_bitmap").as("vp_bitmap"),
        col("in0.device_type").as("device_type"),
        col("in0.view_detection_enabled").as("view_detection_enabled"),
        col("in0.viewdef_definition_id").as("viewdef_definition_id"),
        col("in0.request_uuid").as("request_uuid"),
        col("in0.operating_system_id").as("operating_system_id"),
        col("in0.operating_system_family_id").as("operating_system_family_id"),
        col("in0.allowed_media_types").as("allowed_media_types"),
        col("in0.is_imp_rejecter_applied").as("is_imp_rejecter_applied"),
        col("in0.imp_rejecter_do_auction").as("imp_rejecter_do_auction"),
        col("in0.imp_bid_on").as("imp_bid_on"),
        col("in0.is_prebid").as("is_prebid"),
        col("in0.placement_set_id").as("placement_set_id"),
        col("in0.max_duration").as("max_duration"),
        col("in0.max_number_ads").as("max_number_ads"),
        col("in0.supported_playback_methods").as("supported_playback_methods"),
        col("in0.video_context").as("video_context"),
        col("in0.player_width").as("player_width"),
        col("in0.player_height").as("player_height"),
        col("in0.start_delay").as("start_delay"),
        col("in0.frameworks").as("frameworks"),
        col("in0.protocols").as("protocols"),
        col("in0.supports_skippable").as("supports_skippable"),
        col("in0.min_ad_duration").as("min_ad_duration"),
        col("in0.max_ad_duration").as("max_ad_duration"),
        col("in0.slot_type").as("slot_type"),
        col("in0.ad_slot_position").as("ad_slot_position"),
        col("in0.inventory_url_id").as("inventory_url_id"),
        col("in0.is_dw_seller").as("is_dw_seller"),
        col("in0.is_mediated").as("is_mediated"),
        col("in0.num_of_bids").as("num_of_bids"),
        col("in0.buyer_bid").as("buyer_bid"),
        col("in0.creative_id").as("creative_id"),
        col("in0.filled_number_ads").as("filled_number_ads"),
        col("in0.max_slot_duration").as("max_slot_duration"),
        col("in0.filled_slot_duration").as("filled_slot_duration"),
        col("in0.mobile_app_instance_id").as("mobile_app_instance_id"),
        col("in0.user_id_64").as("user_id_64"),
        col("in0.instance_id").as("instance_id"),
        col("in0.hb_source").as("hb_source"),
        col("in0.content_delivery_type_id").as("content_delivery_type_id"),
        col("in0.content_duration_secs").as("content_duration_secs"),
        col("in0.content_genre_id").as("content_genre_id"),
        col("in0.content_program_type_id").as("content_program_type_id"),
        col("in0.content_rating_id").as("content_rating_id"),
        col("in0.content_network_id").as("content_network_id"),
        col("in0.content_language_id").as("content_language_id"),
        col("in0.external_deal_code").as("external_deal_code"),
        col("in0.creative_duration").as("creative_duration"),
        col("in0.pod_id_64").as("pod_id_64"),
        col("in0.imp_requests").as("imp_requests"),
        col("in0.region_id").as("region_id")
      )
    )
  }

}
