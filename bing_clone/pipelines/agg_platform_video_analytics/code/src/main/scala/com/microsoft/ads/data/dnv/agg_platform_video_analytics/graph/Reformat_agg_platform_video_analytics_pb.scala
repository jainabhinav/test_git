package com.microsoft.ads.data.dnv.agg_platform_video_analytics.graph

import io.prophecy.libs._
import com.microsoft.ads.data.dnv.agg_platform_video_analytics.udfs.PipelineInitCode._
import com.microsoft.ads.data.dnv.agg_platform_video_analytics.udfs.UDFs._
import com.microsoft.ads.data.dnv.agg_platform_video_analytics.udfs.ColumnFunctions._
import com.microsoft.ads.data.dnv.agg_platform_video_analytics.config.Context
import org.apache.spark._
import org.apache.spark.sql._
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types._
import org.apache.spark.sql.expressions._
import java.time._

object Reformat_agg_platform_video_analytics_pb {

  def apply(context: Context, in: DataFrame): DataFrame = {
    val Config = context.config
    in.select(
      coalesce(
        col("agg_dw_pixels.date_time").cast(LongType),
        col("agg_dw_clicks.date_time").cast(LongType),
        col("agg_platform_video_impressions.date_time").cast(LongType),
        col("agg_platform_video_requests.date_time").cast(LongType),
        col("agg_dw_video_events.date_time").cast(LongType),
        col("agg_impbus_clicks.date_time").cast(LongType)
      ).as("date_time"),
      col("agg_platform_video_requests.auction_id_64")
        .cast(LongType)
        .as("auction_id_64"),
      coalesce(
        col("agg_platform_video_impressions.imp_type").cast(IntegerType),
        col("agg_platform_video_requests.imp_type").cast(IntegerType),
        col("agg_dw_clicks.imp_type").cast(IntegerType),
        col("agg_dw_pixels.imp_type").cast(IntegerType),
        col("agg_impbus_clicks.imp_type").cast(IntegerType)
      ).as("imp_type"),
      coalesce(
        when(
          is_not_null(col("agg_platform_video_requests")).and(
            is_not_null(
              col("agg_platform_video_requests.vp_bitmap").cast(LongType)
            )
          ),
          col("agg_platform_video_requests.vp_bitmap").cast(LongType)
        ).cast(LongType),
        when(
          is_not_null(col("agg_dw_video_events")).and(
            is_not_null(col("agg_dw_video_events.vp_bitmap").cast(LongType))
          ),
          col("agg_dw_video_events.vp_bitmap").cast(LongType)
        ).cast(LongType),
        when(is_not_null(col("agg_dw_clicks")).and(
               is_not_null(col("agg_dw_clicks.vp_bitmap").cast(LongType))
             ),
             col("agg_dw_clicks.vp_bitmap").cast(LongType)
        ).cast(LongType),
        when(is_not_null(col("agg_dw_pixels")).and(
               is_not_null(col("agg_dw_pixels.vp_bitmap").cast(LongType))
             ),
             col("agg_dw_pixels.vp_bitmap").cast(LongType)
        ).cast(LongType),
        when(
          is_not_null(col("agg_impbus_clicks")).and(
            is_not_null(col("agg_impbus_clicks.vp_bitmap").cast(LongType))
          ),
          col("agg_impbus_clicks.vp_bitmap").cast(LongType)
        ).cast(LongType)
      ).as("vp_bitmap"),
      lit(null).cast(BooleanType).as("imp_ignored"),
      is_dw_buyer(context).as("is_dw_buyer"),
      coalesce(
        when(col("agg_platform_video_requests.imp_type").cast(
               IntegerType
             ) === lit(7),
             lit(0)
        ).otherwise(lit(1)).cast(IntegerType),
        col("agg_platform_video_impressions.is_dw_seller").cast(IntegerType)
      ).as("is_dw_seller"),
      coalesce(
        col("agg_dw_video_events.seller_member_id").cast(IntegerType),
        col("agg_platform_video_requests.seller_member_id").cast(IntegerType),
        col("agg_platform_video_impressions.seller_member_id").cast(
          IntegerType
        ),
        col("agg_dw_clicks.seller_member_id").cast(IntegerType),
        col("agg_dw_pixels.seller_member_id").cast(IntegerType),
        col("agg_impbus_clicks.seller_member_id").cast(IntegerType)
      ).as("seller_member_id"),
      coalesce(
        col("agg_dw_video_events.publisher_id").cast(IntegerType),
        col("agg_platform_video_requests.publisher_id").cast(IntegerType),
        col("agg_platform_video_impressions.publisher_id").cast(IntegerType),
        col("agg_dw_clicks.publisher_id").cast(IntegerType),
        col("agg_dw_pixels.publisher_id").cast(IntegerType),
        col("agg_impbus_clicks.publisher_id").cast(IntegerType)
      ).as("publisher_id"),
      coalesce(
        col("agg_dw_video_events.site_id").cast(IntegerType),
        col("agg_platform_video_requests.site_id").cast(IntegerType),
        col("agg_dw_clicks.site_id").cast(IntegerType),
        col("agg_dw_pixels.site_id").cast(IntegerType),
        col("agg_impbus_clicks.site_id").cast(IntegerType)
      ).as("site_id"),
      coalesce(
        col("agg_dw_video_events.tag_id").cast(IntegerType),
        col("agg_platform_video_requests.tag_id").cast(IntegerType),
        col("agg_dw_clicks.tag_id").cast(IntegerType),
        col("agg_dw_pixels.tag_id").cast(IntegerType),
        col("agg_impbus_clicks.tag_id").cast(IntegerType)
      ).as("tag_id"),
      col("agg_platform_video_requests.placement_set_id")
        .cast(IntegerType)
        .as("placement_set_id"),
      col("agg_platform_video_requests.call_type").as("call_type"),
      coalesce(
        col("agg_platform_video_requests.application_id"),
        when(is_not_null(col("agg_dw_clicks")).cast(BooleanType),
             coalesce(col("agg_dw_clicks.application_id"), lit("---"))
        ),
        when(is_not_null(col("agg_dw_pixels")).cast(BooleanType),
             coalesce(col("agg_dw_pixels.application_id"), lit("---"))
        ),
        when(is_not_null(col("agg_impbus_clicks")).cast(BooleanType),
             coalesce(col("agg_impbus_clicks.application_id"), lit("---"))
        )
      ).as("application_id"),
      coalesce(
        col("agg_dw_video_events.deal_id").cast(IntegerType),
        col("agg_platform_video_impressions.deal_id").cast(IntegerType),
        col("agg_platform_video_requests.deal_id").cast(IntegerType),
        col("agg_dw_clicks.deal_id").cast(IntegerType),
        col("agg_dw_pixels.deal_id").cast(IntegerType),
        col("agg_impbus_clicks.deal_id").cast(IntegerType)
      ).as("deal_id"),
      col("agg_platform_video_requests.width").cast(IntegerType).as("width"),
      col("agg_platform_video_requests.height").cast(IntegerType).as("height"),
      col("agg_platform_video_requests.content_category_id")
        .cast(IntegerType)
        .as("content_category_id"),
      when(
        size(col("agg_platform_video_requests.allowed_media_types")) > lit(0),
        col("agg_platform_video_requests.allowed_media_types")
      ).as("allowed_media_types"),
      coalesce(
        when(
          coalesce(col("agg_dw_video_events.playback_method").cast(IntegerType),
                   lit(0)
          ) > lit(0),
          col("agg_dw_video_events.playback_method").cast(IntegerType)
        ).cast(IntegerType),
        col("_sup_placement_video_attributes_pb_LOOKUP")
          .getField("playback_method")
          .cast(IntegerType),
        lit(0).cast(IntegerType)
      ).as("playback_method"),
      coalesce(
        col("agg_dw_video_events.video_context").cast(IntegerType),
        when(
          coalesce(
            col("agg_platform_video_requests.video_context").cast(IntegerType),
            lit(0)
          ) === lit(0),
          coalesce(col("_sup_placement_video_attributes_pb_LOOKUP").getField(
                     "video_context"
                   ),
                   lit(0)
          )
        ).otherwise(
            col("agg_platform_video_requests.video_context").cast(IntegerType)
          )
          .cast(IntegerType)
      ).as("video_context"),
      coalesce(
        when(is_not_null(col("agg_dw_video_events")).cast(BooleanType),
             coalesce(col("agg_dw_video_events.player_width").cast(IntegerType),
                      lit(0)
             )
        ).cast(IntegerType),
        col("agg_platform_video_requests.player_width").cast(IntegerType)
      ).as("player_width"),
      coalesce(
        when(
          is_not_null(col("agg_dw_video_events")).cast(BooleanType),
          coalesce(col("agg_dw_video_events.player_height").cast(IntegerType),
                   lit(0)
          )
        ).cast(IntegerType),
        col("agg_platform_video_requests.player_height").cast(IntegerType)
      ).as("player_height"),
      col("agg_platform_video_requests.max_duration")
        .cast(IntegerType)
        .as("max_duration"),
      col("agg_platform_video_requests.max_number_ads")
        .cast(IntegerType)
        .as("max_number_ads"),
      col("agg_platform_video_requests.start_delay")
        .cast(IntegerType)
        .as("start_delay"),
      col("agg_platform_video_requests.frameworks").as("frameworks"),
      col("agg_platform_video_requests.protocols").as("protocols"),
      col("agg_platform_video_requests.supports_skippable")
        .cast(BooleanType)
        .as("supports_skippable"),
      col("agg_platform_video_requests.min_ad_duration")
        .cast(IntegerType)
        .as("min_ad_duration"),
      col("agg_platform_video_requests.max_ad_duration")
        .cast(IntegerType)
        .as("max_ad_duration"),
      col("agg_platform_video_requests.slot_type")
        .cast(IntegerType)
        .as("slot_type"),
      col("agg_platform_video_requests.ad_slot_position")
        .cast(IntegerType)
        .as("ad_slot_position"),
      col("agg_platform_video_requests.is_prebid")
        .cast(BooleanType)
        .as("is_prebid"),
      (size(col("agg_platform_video_requests.allowed_media_types")) > lit(1))
        .as("is_super_auction"),
      coalesce(col("agg_platform_video_requests.is_mediated").cast(BooleanType),
               lit(0).cast(BooleanType)
      ).as("is_mediated"),
      coalesce(
        col("agg_dw_video_events.buyer_member_id").cast(IntegerType),
        col("agg_platform_video_impressions.buyer_member_id").cast(IntegerType),
        col("agg_dw_clicks.buyer_member_id").cast(IntegerType),
        col("agg_dw_pixels.buyer_member_id").cast(IntegerType),
        col("agg_impbus_clicks.buyer_member_id").cast(IntegerType)
      ).as("buyer_member_id"),
      coalesce(
        f_calc_derived_fields(
          col("agg_dw_video_events"),
          col("agg_platform_video_impressions"),
          col("agg_platform_video_requests"),
          col("agg_dw_clicks"),
          col("agg_dw_pixels"),
          f_get_winning_creative_id(col("agg_dw_video_events"),
                                    col("agg_platform_video_impressions")
          ).cast(IntegerType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).getField("advertiser_id"),
        when(
          is_not_null(col("_sup_creative_media_subtype_pb_LOOKUP")).cast(
            BooleanType
          ),
          coalesce(col("_sup_creative_media_subtype_pb_LOOKUP").getField(
                     "advertiser_id"
                   ),
                   lit(0)
          )
        )
      ).cast(IntegerType).as("advertiser_id"),
      coalesce(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          coalesce(col("agg_platform_video_impressions.insertion_order_id")
                     .cast(IntegerType),
                   lit(0)
          )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_clicks")).cast(BooleanType),
             coalesce(col("agg_dw_clicks.insertion_order_id").cast(IntegerType),
                      lit(0)
             )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_pixels")).cast(BooleanType),
             coalesce(col("agg_dw_pixels.insertion_order_id").cast(IntegerType),
                      lit(0)
             )
        ).cast(IntegerType),
        when(is_not_null(col("agg_impbus_clicks")).cast(BooleanType),
             coalesce(
               col("agg_impbus_clicks.insertion_order_id").cast(IntegerType),
               lit(0)
             )
        ).cast(IntegerType)
      ).as("insertion_order_id"),
      coalesce(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          coalesce(col("agg_platform_video_impressions.campaign_group_id").cast(
                     IntegerType
                   ),
                   lit(0)
          )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_clicks")).cast(BooleanType),
             coalesce(col("agg_dw_clicks.campaign_group_id").cast(IntegerType),
                      lit(0)
             )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_pixels")).cast(BooleanType),
             coalesce(col("agg_dw_pixels.campaign_group_id").cast(IntegerType),
                      lit(0)
             )
        ).cast(IntegerType),
        when(
          is_not_null(col("agg_impbus_clicks")).cast(BooleanType),
          coalesce(col("agg_impbus_clicks.campaign_group_id").cast(IntegerType),
                   lit(0)
          )
        ).cast(IntegerType)
      ).as("campaign_group_id"),
      coalesce(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          coalesce(
            col("agg_platform_video_impressions.campaign_id").cast(IntegerType),
            lit(0)
          )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_clicks")).cast(BooleanType),
             coalesce(col("agg_dw_clicks.campaign_id").cast(IntegerType),
                      lit(0)
             )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_pixels")).cast(BooleanType),
             coalesce(col("agg_dw_pixels.campaign_id").cast(IntegerType),
                      lit(0)
             )
        ).cast(IntegerType),
        when(is_not_null(col("agg_impbus_clicks")).cast(BooleanType),
             coalesce(col("agg_impbus_clicks.campaign_id").cast(IntegerType),
                      lit(0)
             )
        ).cast(IntegerType)
      ).as("campaign_id"),
      bidder_id(context).as("bidder_id"),
      media_type(context).as("media_type"),
      coalesce(
        when(is_not_null(col("agg_platform_video_requests")).cast(BooleanType),
             lit(null)
        ).cast(IntegerType),
        when(
          is_not_null(col("agg_platform_video_impressions")).and(
            col("agg_dw_video_events").isNull
          ),
          coalesce(
            col("agg_platform_video_impressions.brand_id").cast(IntegerType),
            lit(0)
          )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_video_events")).cast(BooleanType),
             coalesce(col("agg_dw_video_events.brand_id").cast(IntegerType),
                      lit(0)
             )
        ).cast(IntegerType),
        col("agg_dw_clicks.brand_id").cast(IntegerType),
        col("agg_dw_pixels.brand_id").cast(IntegerType),
        col("agg_impbus_clicks.brand_id").cast(IntegerType)
      ).as("brand_id"),
      f_calc_derived_fields(
        col("agg_dw_video_events"),
        col("agg_platform_video_impressions"),
        col("agg_platform_video_requests"),
        col("agg_dw_clicks"),
        col("agg_dw_pixels"),
        f_get_winning_creative_id(col("agg_dw_video_events"),
                                  col("agg_platform_video_impressions")
        ).cast(IntegerType),
        lit(Config.XR_BUSINESS_DATE),
        lit(Config.XR_BUSINESS_HOUR)
      ).getField("creative_id").cast(IntegerType).as("creative_id"),
      lit(null).cast(IntegerType).as("latency_ms"),
      when(
        f_is_curr_hour(col("agg_dw_video_events.date_time").cast(LongType),
                       lit(Config.XR_BUSINESS_DATE),
                       lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType)
          .and(
            col("agg_dw_video_events.video_had_error")
              .cast(IntegerType) > lit(0)
          ),
        col("agg_dw_video_events.error_code").cast(IntegerType)
      ).cast(IntegerType).as("vast_error_code"),
      lit(null).cast(IntegerType).as("wrapper_vast_error_code"),
      lit(null).cast(IntegerType).as("wrapper_internal_error_code"),
      lit(null).cast(IntegerType).as("vast_wrapper_count"),
      col("agg_platform_video_requests.creative_duration")
        .cast(IntegerType)
        .as("creative_duration"),
      lit(null).cast(IntegerType).as("creative_mime_type"),
      when(
        coalesce(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("creative_id"),
          lit(0)
        ) > lit(0),
        col("_sup_creative_media_subtype_pb_LOOKUP").getField(
          "minimum_vast_version_id"
        )
      ).cast(IntegerType).as("creative_minimum_vast_version"),
      when(
        coalesce(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("creative_id"),
          lit(0)
        ) > lit(0),
        col("_sup_creative_media_subtype_pb_LOOKUP").getField("vast_type_id")
      ).cast(IntegerType).as("creative_vast_type"),
      lit(null).cast(IntegerType).as("creative_is_skippable"),
      coalesce(
        when(
          coalesce(col("agg_platform_video_impressions.viewdef_definition_id")
                     .cast(IntegerType),
                   lit(0)
          ) =!= lit(0),
          col("agg_platform_video_impressions.viewdef_definition_id").cast(
            IntegerType
          )
        ).cast(IntegerType),
        when(
          coalesce(col("agg_dw_clicks.viewdef_definition_id").cast(IntegerType),
                   lit(0)
          ) =!= lit(0),
          col("agg_dw_clicks.viewdef_definition_id").cast(IntegerType)
        ).cast(IntegerType),
        when(
          coalesce(col("agg_dw_pixels.viewdef_definition_id").cast(IntegerType),
                   lit(0)
          ) =!= lit(0),
          col("agg_dw_pixels.viewdef_definition_id").cast(IntegerType)
        ).cast(IntegerType),
        col("agg_platform_video_requests.viewdef_definition_id").cast(
          IntegerType
        ),
        when(
          coalesce(
            col("agg_impbus_clicks.viewdef_definition_id").cast(IntegerType),
            lit(0)
          ) =!= lit(0),
          col("agg_impbus_clicks.viewdef_definition_id").cast(IntegerType)
        ).cast(IntegerType)
      ).as("viewdef_definition_id"),
      col("agg_dw_video_events.companion_creative_id")
        .cast(IntegerType)
        .as("companion_creative_id"),
      when(
        coalesce(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("creative_id"),
          lit(0)
        ) > lit(0),
        f_is_vpaid(
          col("_sup_creative_media_subtype_pb_LOOKUP").getField("framework_ids")
        ).cast(BooleanType)
      ).as("is_vpaid"),
      col("agg_platform_video_requests.view_detection_enabled")
        .cast(IntegerType)
        .as("view_detection_enabled"),
      col("agg_platform_video_requests.operating_system_id")
        .cast(IntegerType)
        .as("operating_system_id"),
      col("agg_platform_video_requests.operating_system_family_id")
        .cast(IntegerType)
        .as("operating_system_family_id"),
      col("agg_platform_video_requests.browser")
        .cast(IntegerType)
        .as("browser"),
      coalesce(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          coalesce(
            col("agg_platform_video_impressions.device_type").cast(IntegerType),
            lit(0)
          )
        ).cast(IntegerType),
        col("agg_platform_video_requests.device_type").cast(IntegerType),
        col("agg_dw_clicks.device_type").cast(IntegerType),
        col("agg_dw_pixels.device_type").cast(IntegerType),
        col("agg_impbus_clicks.device_type").cast(IntegerType)
      ).as("device_type"),
      coalesce(
        col("agg_platform_video_requests.supply_type").cast(IntegerType),
        col("agg_dw_clicks.supply_type").cast(IntegerType),
        col("agg_dw_pixels.supply_type").cast(IntegerType),
        col("agg_impbus_clicks.supply_type").cast(IntegerType)
      ).as("supply_type"),
      coalesce(
        when(
          is_not_null(col("agg_platform_video_requests.geo_country"))
            .or(col("agg_platform_video_requests.geo_country") =!= lit("--")),
          col("agg_platform_video_requests.geo_country")
        ),
        col("agg_dw_video_events.geo_country"),
        col("agg_platform_video_impressions.geo_country"),
        col("agg_dw_clicks.geo_country"),
        col("agg_dw_pixels.geo_country"),
        col("agg_impbus_clicks.geo_country")
      ).as("geo_country"),
      col("agg_platform_video_requests.geo_region").as("geo_region"),
      col("agg_platform_video_requests.city").cast(IntegerType).as("city"),
      col("agg_platform_video_requests.language")
        .cast(IntegerType)
        .as("language"),
      f_calc_financials(
        col("agg_dw_video_events"),
        col("agg_platform_video_impressions"),
        col("agg_dw_clicks"),
        col("agg_dw_pixels"),
        lit(Config.XR_BUSINESS_DATE),
        lit(Config.XR_BUSINESS_HOUR)
      ).getField("booked_revenue_dollars")
        .cast(DoubleType)
        .as("booked_revenue_dollars"),
      f_calc_financials(
        col("agg_dw_video_events"),
        col("agg_platform_video_impressions"),
        col("agg_dw_clicks"),
        col("agg_dw_pixels"),
        lit(Config.XR_BUSINESS_DATE),
        lit(Config.XR_BUSINESS_HOUR)
      ).getField("reseller_revenue")
        .cast(DoubleType)
        .as("reseller_revenue_dollars"),
      f_calc_financials(
        col("agg_dw_video_events"),
        col("agg_platform_video_impressions"),
        col("agg_dw_clicks"),
        col("agg_dw_pixels"),
        lit(Config.XR_BUSINESS_DATE),
        lit(Config.XR_BUSINESS_HOUR)
      ).getField("media_cost_dollar_cpm")
        .cast(DoubleType)
        .as("buyer_media_cost_dollars"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_impressions.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        col("agg_platform_video_impressions.seller_media_cost_cpm") / lit(1000)
      ).cast(DoubleType).as("seller_media_cost_dollars"),
      f_calc_financials(
        col("agg_dw_video_events"),
        col("agg_platform_video_impressions"),
        col("agg_dw_clicks"),
        col("agg_dw_pixels"),
        lit(Config.XR_BUSINESS_DATE),
        lit(Config.XR_BUSINESS_HOUR)
      ).getField("commissions").cast(DoubleType).as("commissions"),
      f_calc_financials(
        col("agg_dw_video_events"),
        col("agg_platform_video_impressions"),
        col("agg_dw_clicks"),
        col("agg_dw_pixels"),
        lit(Config.XR_BUSINESS_DATE),
        lit(Config.XR_BUSINESS_HOUR)
      ).getField("serving_fees").cast(DoubleType).as("serving_fees"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_impressions.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        col("agg_platform_video_impressions.auction_service_fees")
      ).cast(DoubleType).as("auction_service_fees"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_impressions.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        col("agg_platform_video_impressions.auction_service_deduction")
      ).cast(DoubleType).as("auction_service_deduction"),
      lit(null).cast(DoubleType).as("creative_overage_fees"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_impressions.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        col("agg_platform_video_impressions.seller_deduction")
      ).cast(DoubleType).as("seller_deduction"),
      lit(null).cast(DoubleType).as("discrepancy_allowance"),
      coalesce(
        when(
          f_is_curr_hour(
            col("agg_platform_video_impressions.date_time").cast(LongType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).cast(BooleanType),
          coalesce(col("agg_platform_video_impressions.advertiser_currency"),
                   lit("USD")
          )
        ),
        lit("USD")
      ).as("advertiser_currency"),
      coalesce(
        when(
          f_is_curr_hour(
            col("agg_platform_video_impressions.date_time").cast(LongType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).cast(BooleanType),
          col("agg_platform_video_impressions.advertiser_exchange_rate")
        ).cast(DoubleType),
        col("agg_dw_clicks.advertiser_exchange_rate").cast(DoubleType),
        col("agg_dw_pixels.advertiser_exchange_rate").cast(DoubleType),
        col("agg_impbus_clicks.advertiser_exchange_rate").cast(DoubleType)
      ).as("advertiser_exchange_rate"),
      coalesce(
        when(
          f_is_curr_hour(
            col("agg_platform_video_impressions.date_time").cast(LongType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).cast(BooleanType),
          coalesce(col("agg_platform_video_impressions.publisher_currency"),
                   lit("USD")
          )
        ),
        lit("USD")
      ).as("publisher_currency"),
      coalesce(
        when(
          f_is_curr_hour(
            col("agg_platform_video_impressions.date_time").cast(LongType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).cast(BooleanType),
          col("agg_platform_video_impressions.publisher_exchange_rate")
        ).cast(DoubleType),
        col("agg_dw_clicks.publisher_exchange_rate").cast(DoubleType),
        col("agg_dw_pixels.publisher_exchange_rate").cast(DoubleType),
        col("agg_impbus_clicks.publisher_exchange_rate").cast(DoubleType)
      ).as("publisher_exchange_rate"),
      col("agg_dw_pixels.post_click_revenue")
        .cast(DoubleType)
        .as("post_click_revenue"),
      col("agg_dw_pixels.post_view_revenue")
        .cast(DoubleType)
        .as("post_view_revenue"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_requests.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        lit(1)
      ).cast(LongType).as("ad_requests"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_requests.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        when(col("agg_platform_video_requests.imp_blacklist_or_fraud").cast(
               IntegerType
             ) > lit(0),
             lit(1)
        ).otherwise(lit(0))
      ).cast(LongType).as("blacklisted_imps"),
      when(
        f_is_curr_hour(col("agg_dw_video_events.date_time").cast(LongType),
                       lit(Config.XR_BUSINESS_DATE),
                       lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_dw_video_events.video_was_served").cast(IntegerType),
                 lit(0)
        )
      ).cast(LongType).as("ad_responses"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_impressions.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        lit(1)
      ).cast(LongType).as("imps"),
      when(
        f_is_curr_hour(col("agg_dw_video_events.date_time").cast(LongType),
                       lit(Config.XR_BUSINESS_DATE),
                       lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_dw_video_events.video_started").cast(IntegerType),
                 lit(0)
        )
      ).cast(LongType).as("starts"),
      when(
        f_is_curr_hour(col("agg_dw_video_events.date_time").cast(LongType),
                       lit(Config.XR_BUSINESS_DATE),
                       lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_dw_video_events.video_was_skipped").cast(IntegerType),
                 lit(0)
        )
      ).cast(LongType).as("skips"),
      when(
        f_is_curr_hour(col("agg_dw_video_events.date_time").cast(LongType),
                       lit(Config.XR_BUSINESS_DATE),
                       lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_dw_video_events.video_had_error").cast(IntegerType),
                 lit(0)
        )
      ).cast(LongType).as("errors"),
      when(
        f_is_curr_hour(col("agg_dw_video_events.date_time").cast(LongType),
                       lit(Config.XR_BUSINESS_DATE),
                       lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_dw_video_events.video_hit_25_pct").cast(IntegerType),
                 lit(0)
        )
      ).cast(LongType).as("first_quartiles"),
      when(
        f_is_curr_hour(col("agg_dw_video_events.date_time").cast(LongType),
                       lit(Config.XR_BUSINESS_DATE),
                       lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_dw_video_events.video_hit_50_pct").cast(IntegerType),
                 lit(0)
        )
      ).cast(LongType).as("second_quartiles"),
      when(
        f_is_curr_hour(col("agg_dw_video_events.date_time").cast(LongType),
                       lit(Config.XR_BUSINESS_DATE),
                       lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_dw_video_events.video_hit_75_pct").cast(IntegerType),
                 lit(0)
        )
      ).cast(LongType).as("third_quartiles"),
      when(
        f_is_curr_hour(col("agg_dw_video_events.date_time").cast(LongType),
                       lit(Config.XR_BUSINESS_DATE),
                       lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_dw_video_events.video_completed").cast(IntegerType),
                 lit(0)
        )
      ).cast(LongType).as("completions"),
      when(is_not_null(col("agg_dw_clicks")).or(
             is_not_null(col("agg_impbus_clicks"))
           ),
           lit(1)
      ).cast(LongType).as("clicks"),
      col("agg_dw_pixels.post_click_conv")
        .cast(LongType)
        .as("post_click_conversions"),
      col("agg_dw_pixels.post_view_conv")
        .cast(LongType)
        .as("post_view_conversions"),
      when(
        f_is_curr_hour(col("agg_dw_video_events.date_time").cast(LongType),
                       lit(Config.XR_BUSINESS_DATE),
                       lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_dw_video_events.companion_imps").cast(LongType),
                 lit(0)
        )
      ).cast(LongType).as("companion_imps"),
      when(
        f_is_curr_hour(col("agg_dw_video_events.date_time").cast(LongType),
                       lit(Config.XR_BUSINESS_DATE),
                       lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_dw_video_events.companion_clicks").cast(LongType),
                 lit(0)
        )
      ).cast(LongType).as("companion_clicks"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_impressions.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(
          col("agg_platform_video_impressions.viewable").cast(IntegerType),
          lit(0)
        )
      ).cast(LongType).as("viewed_imps"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_impressions.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_platform_video_impressions.view_measurable").cast(
                   IntegerType
                 ),
                 lit(0)
        )
      ).cast(LongType).as("view_measurable_imps"),
      when(size(
             col("agg_platform_video_requests.supported_playback_methods")
           ) > lit(0),
           col("agg_platform_video_requests.supported_playback_methods")
      ).as("supported_playback_methods"),
      coalesce(
        col("agg_platform_video_requests.inventory_url_id").cast(IntegerType),
        col("agg_platform_video_impressions.inventory_url_id").cast(
          IntegerType
        ),
        col("agg_dw_clicks.inventory_url_id").cast(IntegerType),
        col("agg_dw_pixels.inventory_url_id").cast(IntegerType),
        col("agg_impbus_clicks.inventory_url_id").cast(IntegerType)
      ).as("inventory_url_id"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_impressions.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_platform_video_impressions.viewdef_viewed_imps").cast(
                   LongType
                 ),
                 lit(0)
        )
      ).cast(LongType).as("viewdef_viewed_imps"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_requests.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(
          col("agg_platform_video_requests.imp_bid_on").cast(IntegerType),
          lit(0)
        )
      ).cast(IntegerType).as("imp_bid_on"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_requests.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(
          col("agg_platform_video_requests.num_of_bids").cast(IntegerType),
          lit(0)
        )
      ).cast(IntegerType).as("num_of_bids"),
      when(
        f_is_curr_hour(
          col("agg_platform_video_requests.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType),
        coalesce(col("agg_platform_video_requests.buyer_bid"), lit(0.0d))
      ).cast(DoubleType).as("buyer_bid"),
      coalesce(
        col("agg_platform_video_requests.filled_number_ads").cast(IntegerType),
        lit(0)
      ).cast(IntegerType).as("filled_number_ads"),
      coalesce(
        col("agg_platform_video_requests.max_slot_duration").cast(IntegerType),
        lit(0)
      ).cast(IntegerType).as("max_slot_duration"),
      coalesce(col("agg_platform_video_requests.filled_slot_duration").cast(
                 IntegerType
               ),
               lit(0)
      ).cast(IntegerType).as("filled_slot_duration"),
      coalesce(
        col("agg_platform_video_requests.imp_blacklist_or_fraud").cast(
          IntegerType
        ),
        col("agg_platform_video_impressions.imp_blacklist_or_fraud").cast(
          IntegerType
        )
      ).as("imp_blacklist_or_fraud"),
      coalesce(
        col("agg_platform_video_requests.imp_rejecter_do_auction").cast(
          BooleanType
        ),
        col("agg_platform_video_impressions.imp_rejecter_do_auction").cast(
          BooleanType
        )
      ).as("imp_rejecter_do_auction"),
      coalesce(
        when(
          f_is_curr_hour(
            col("agg_platform_video_requests.date_time").cast(LongType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).cast(BooleanType),
          when(
            (col("agg_platform_video_requests.imp_blacklist_or_fraud").cast(
              IntegerType
            ) === lit(0)).and(
              col("agg_platform_video_requests.imp_rejecter_do_auction")
                .cast(BooleanType)
            ),
            lit(1)
          ).otherwise(lit(0))
        ).cast(LongType),
        when(
          f_is_curr_hour(
            col("agg_platform_video_impressions.date_time").cast(LongType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).cast(BooleanType),
          when(
            (col("agg_platform_video_impressions.imp_blacklist_or_fraud").cast(
              IntegerType
            ) === lit(0)).and(
              col("agg_platform_video_impressions.imp_rejecter_do_auction")
                .cast(BooleanType)
            ),
            lit(1)
          ).otherwise(lit(0))
        ).cast(LongType)
      ).as("biddable_imps"),
      lit(null).cast(DoubleType).as("predicted_100pd_video_completion_rate"),
      coalesce(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          coalesce(col("agg_platform_video_impressions.buyer_trx_event_id")
                     .cast(IntegerType),
                   lit(1)
          )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_clicks")).cast(BooleanType),
             coalesce(col("agg_dw_clicks.buyer_trx_event_id").cast(IntegerType),
                      lit(1)
             )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_pixels")).cast(BooleanType),
             coalesce(col("agg_dw_pixels.buyer_trx_event_id").cast(IntegerType),
                      lit(1)
             )
        ).cast(IntegerType),
        when(is_not_null(col("agg_impbus_clicks")).cast(BooleanType),
             coalesce(
               col("agg_impbus_clicks.buyer_trx_event_id").cast(IntegerType),
               lit(1)
             )
        ).cast(IntegerType)
      ).as("buyer_trx_event_id"),
      coalesce(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          coalesce(col("agg_platform_video_impressions.seller_trx_event_id")
                     .cast(IntegerType),
                   lit(1)
          )
        ).cast(IntegerType),
        when(
          is_not_null(col("agg_dw_clicks")).cast(BooleanType),
          coalesce(col("agg_dw_clicks.seller_trx_event_id").cast(IntegerType),
                   lit(1)
          )
        ).cast(IntegerType),
        when(
          is_not_null(col("agg_dw_pixels")).cast(BooleanType),
          coalesce(col("agg_dw_pixels.seller_trx_event_id").cast(IntegerType),
                   lit(1)
          )
        ).cast(IntegerType),
        when(is_not_null(col("agg_impbus_clicks")).cast(BooleanType),
             coalesce(
               col("agg_impbus_clicks.seller_trx_event_id").cast(IntegerType),
               lit(1)
             )
        ).cast(IntegerType)
      ).as("seller_trx_event_id"),
      coalesce(
        when(
          f_is_curr_hour(
            col("agg_platform_video_impressions.date_time").cast(LongType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).cast(BooleanType)
            .and(
              col("agg_platform_video_impressions.is_unit_of_buyer_trx")
                .cast(BooleanType)
            )
            .and(
              (col("agg_platform_video_impressions.imp_type")
                .cast(IntegerType) === lit(7)).or(
                col("agg_platform_video_impressions.imp_type")
                  .cast(IntegerType) === lit(5)
              )
            ),
          lit(1)
        ).cast(LongType),
        when(
          col("agg_dw_clicks.is_unit_of_trx")
            .cast(BooleanType)
            .and(
              (col("agg_dw_clicks.imp_type").cast(IntegerType) === lit(5))
                .or(col("agg_dw_clicks.imp_type").cast(IntegerType) === lit(7))
            ),
          lit(1)
        ).cast(LongType),
        when(
          col("agg_dw_pixels.is_unit_of_trx")
            .cast(BooleanType)
            .and(
              (col("agg_dw_pixels.imp_type").cast(IntegerType) === lit(5))
                .or(col("agg_dw_pixels.imp_type").cast(IntegerType) === lit(7))
            ),
          lit(1)
        ).cast(LongType)
      ).as("buyer_payment_event_units"),
      seller_revenue_event_units(context).as("seller_revenue_event_units"),
      coalesce(
        col("agg_platform_video_requests.mobile_app_instance_id").cast(
          IntegerType
        ),
        col("agg_platform_video_impressions.mobile_app_instance_id").cast(
          IntegerType
        ),
        col("agg_dw_clicks.mobile_app_instance_id").cast(IntegerType),
        col("agg_dw_pixels.mobile_app_instance_id").cast(IntegerType),
        col("agg_impbus_clicks.mobile_app_instance_id").cast(IntegerType)
      ).as("mobile_app_instance_id"),
      f_cal_protocals_bitmap(
        col("agg_platform_video_requests.allowed_media_types")
      ).cast(IntegerType).as("allowed_media_types_bitmap"),
      f_cal_protocals_bitmap(
        f_map_video_protocol_enum(col("agg_platform_video_requests.protocols"))
      ).cast(IntegerType).as("protocols_bitmap"),
      f_cal_protocals_bitmap(col("agg_platform_video_requests.frameworks"))
        .cast(IntegerType)
        .as("frameworks_bitmap"),
      coalesce(
        when(is_not_null(col("agg_dw_pixels")).cast(BooleanType),
             coalesce(col("agg_dw_pixels.user_id_64").cast(LongType), lit(0))
        ).cast(LongType),
        when(is_not_null(col("agg_dw_clicks")).cast(BooleanType),
             coalesce(col("agg_dw_clicks.user_id_64").cast(LongType), lit(0))
        ).cast(LongType),
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          coalesce(
            col("agg_platform_video_impressions.user_id_64").cast(LongType),
            lit(0)
          )
        ).cast(LongType),
        coalesce(col("agg_platform_video_requests.user_id_64").cast(LongType),
                 lit(0)
        ).cast(LongType),
        when(is_not_null(col("agg_impbus_clicks")).cast(BooleanType),
             coalesce(col("agg_impbus_clicks.user_id_64").cast(LongType),
                      lit(0)
             )
        ).cast(LongType)
      ).as("user_id_64"),
      coalesce(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          coalesce(
            col("agg_platform_video_impressions.split_id").cast(IntegerType),
            lit(0)
          )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_clicks")).cast(BooleanType),
             coalesce(col("agg_dw_clicks.split_id").cast(IntegerType), lit(0))
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_pixels")).cast(BooleanType),
             coalesce(col("agg_dw_pixels.split_id").cast(IntegerType), lit(0))
        ).cast(IntegerType),
        when(is_not_null(col("agg_impbus_clicks")).cast(BooleanType),
             coalesce(col("agg_impbus_clicks.split_id").cast(IntegerType),
                      lit(0)
             )
        ).cast(IntegerType)
      ).as("split_id"),
      coalesce(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          coalesce(col("agg_platform_video_impressions.campaign_group_type_id")
                     .cast(IntegerType),
                   lit(0)
          )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_clicks")).cast(BooleanType),
             coalesce(
               col("agg_dw_clicks.campaign_group_type_id").cast(IntegerType),
               lit(0)
             )
        ).cast(IntegerType),
        when(is_not_null(col("agg_dw_pixels")).cast(BooleanType),
             coalesce(
               col("agg_dw_pixels.campaign_group_type_id").cast(IntegerType),
               lit(0)
             )
        ).cast(IntegerType),
        when(is_not_null(col("agg_impbus_clicks")).cast(BooleanType),
             coalesce(col("agg_impbus_clicks.campaign_group_type_id").cast(
                        IntegerType
                      ),
                      lit(0)
             )
        ).cast(IntegerType)
      ).as("campaign_group_type_id"),
      advertiser_default_currency(context).as("advertiser_default_currency"),
      advertiser_default_exchange_rate(context)
        .as("advertiser_default_exchange_rate"),
      member_currency(context).as("member_currency"),
      member_exchange_rate(context).as("member_exchange_rate"),
      billing_currency(context).as("billing_currency"),
      billing_exchange_rate(context).as("billing_exchange_rate"),
      f_calc_derived_fields(
        col("agg_dw_video_events"),
        col("agg_platform_video_impressions"),
        col("agg_platform_video_requests"),
        col("agg_dw_clicks"),
        col("agg_dw_pixels"),
        f_get_winning_creative_id(col("agg_dw_video_events"),
                                  col("agg_platform_video_impressions")
        ).cast(IntegerType),
        lit(Config.XR_BUSINESS_DATE),
        lit(Config.XR_BUSINESS_HOUR)
      ).getField("fx_rate_snapshot_id")
        .cast(IntegerType)
        .as("fx_rate_snapshot_id"),
      col("agg_platform_video_requests.hb_source")
        .cast(IntegerType)
        .as("hb_source"),
      coalesce(
        col("agg_dw_video_events.bidder_seat_id").cast(IntegerType),
        col("agg_platform_video_impressions.bidder_seat_id").cast(IntegerType),
        col("agg_dw_clicks.bidder_seat_id").cast(IntegerType),
        col("agg_dw_pixels.bidder_seat_id").cast(IntegerType),
        col("agg_impbus_clicks.bidder_seat_id").cast(IntegerType)
      ).as("bidder_seat_id"),
      coalesce(col("agg_platform_video_requests.content_delivery_type_id").cast(
                 IntegerType
               ),
               lit(0)
      ).cast(IntegerType).as("content_delivery_type_id"),
      coalesce(col("agg_platform_video_requests.content_duration_secs").cast(
                 IntegerType
               ),
               lit(0)
      ).cast(IntegerType).as("content_duration_secs"),
      coalesce(
        col("agg_platform_video_requests.content_genre_id").cast(IntegerType),
        lit(0)
      ).cast(IntegerType).as("content_genre_id"),
      coalesce(col("agg_platform_video_requests.content_program_type_id").cast(
                 IntegerType
               ),
               lit(0)
      ).cast(IntegerType).as("content_program_type_id"),
      coalesce(
        col("agg_platform_video_requests.content_rating_id").cast(IntegerType),
        lit(0)
      ).cast(IntegerType).as("content_rating_id"),
      coalesce(
        col("agg_platform_video_requests.content_network_id").cast(IntegerType),
        lit(0)
      ).cast(IntegerType).as("content_network_id"),
      coalesce(col("agg_platform_video_requests.content_language_id").cast(
                 IntegerType
               ),
               lit(0)
      ).cast(IntegerType).as("content_language_id"),
      col("agg_platform_video_requests.external_deal_code")
        .as("external_deal_code"),
      col("agg_platform_video_requests.pod_id_64")
        .cast(LongType)
        .as("pod_id_64"),
      lit(null).cast(LongType).as("imp_requests"),
      col("agg_dw_video_events.fallback_ad_index")
        .cast(IntegerType)
        .as("fallback_ad_index"),
      region_id(context).as("region_id")
    )
  }

  def media_type(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    coalesce(
      when(
        coalesce(
          col("agg_platform_video_requests.creative_id").cast(IntegerType),
          lit(0)
        ) > lit(0),
        col("_sup_creative_media_subtype_pb_LOOKUP1").getField("media_subtype")
      ).cast(IntegerType),
      when(
        coalesce(col("agg_dw_video_events.creative_id").cast(IntegerType),
                 lit(0)
        ) > lit(0),
        col("_sup_creative_media_subtype_pb_LOOKUP2").getField("media_subtype")
      ).cast(IntegerType),
      when(
        coalesce(
          col("agg_platform_video_impressions.creative_id").cast(IntegerType),
          lit(0)
        ) > lit(0),
        col("_sup_creative_media_subtype_pb_LOOKUP3").getField("media_subtype")
      ).otherwise(
          col("agg_platform_video_impressions.media_type").cast(IntegerType)
        )
        .cast(IntegerType),
      when(
        coalesce(col("agg_dw_clicks.creative_id").cast(IntegerType),
                 lit(0)
        ) > lit(0),
        col("_sup_creative_media_subtype_pb_LOOKUP4").getField("media_subtype")
      ).otherwise(col("agg_dw_clicks.media_type").cast(IntegerType))
        .cast(IntegerType),
      when(
        coalesce(col("agg_dw_pixels.creative_id").cast(IntegerType),
                 lit(0)
        ) > lit(0),
        col("_sup_creative_media_subtype_pb_LOOKUP5").getField("media_subtype")
      ).otherwise(col("agg_dw_pixels.media_type").cast(IntegerType))
        .cast(IntegerType),
      when(
        coalesce(col("agg_impbus_clicks.creative_id").cast(IntegerType),
                 lit(0)
        ) > lit(0),
        col("_sup_creative_media_subtype_pb_LOOKUP6").getField("media_subtype")
      ).otherwise(col("agg_impbus_clicks.media_type").cast(IntegerType))
        .cast(IntegerType)
    )
  }

  def seller_revenue_event_units(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    coalesce(
      when(
        f_is_curr_hour(
          col("agg_platform_video_impressions.date_time").cast(LongType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).cast(BooleanType)
          .and(
            col("agg_platform_video_impressions.is_unit_of_seller_trx")
              .cast(BooleanType)
          )
          .and(
            (col("agg_platform_video_impressions.imp_type")
              .cast(IntegerType) === lit(6)).or(
              col("agg_platform_video_impressions.imp_type")
                .cast(IntegerType) === lit(5)
            )
          )
          .and(
            not(
              col("agg_platform_video_impressions.is_unit_of_buyer_trx")
                .cast(BooleanType)
                .and(
                  (col("agg_platform_video_impressions.imp_type")
                    .cast(IntegerType) === lit(7)).or(
                    col("agg_platform_video_impressions.imp_type")
                      .cast(IntegerType) === lit(5)
                  )
                )
            ).cast(BooleanType)
          ),
        lit(1)
      ).cast(LongType),
      when(
        col("agg_dw_clicks.is_unit_of_trx")
          .cast(BooleanType)
          .and(
            (col("agg_dw_clicks.imp_type").cast(IntegerType) === lit(5))
              .or(col("agg_dw_clicks.imp_type").cast(IntegerType) === lit(6))
          ),
        lit(1)
      ).cast(LongType),
      when(
        col("agg_dw_pixels.is_unit_of_trx")
          .cast(BooleanType)
          .and(
            (col("agg_dw_pixels.imp_type").cast(IntegerType) === lit(5))
              .or(col("agg_dw_pixels.imp_type").cast(IntegerType) === lit(6))
          ),
        lit(1)
      ).cast(LongType),
      when(
        col("agg_impbus_clicks.is_unit_of_trx")
          .cast(BooleanType)
          .and(col("agg_impbus_clicks.imp_type").cast(IntegerType) === lit(6)),
        lit(1)
      ).cast(LongType)
    )
  }

  def advertiser_default_currency(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    when(
      is_not_null(col("agg_dw_pixels")).cast(BooleanType),
      f_currency_mapper(
        f_calc_derived_fields(
          col("agg_dw_video_events"),
          col("agg_platform_video_impressions"),
          col("agg_platform_video_requests"),
          col("agg_dw_clicks"),
          col("agg_dw_pixels"),
          f_get_winning_creative_id(col("agg_dw_video_events"),
                                    col("agg_platform_video_impressions")
          ).cast(IntegerType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).getField("fx_rate_snapshot_id"),
        col("agg_dw_pixels.buyer_member_id").cast(IntegerType),
        col("agg_dw_pixels.seller_member_id").cast(IntegerType),
        col("agg_dw_pixels.advertiser_id").cast(IntegerType),
        col("agg_dw_pixels.imp_type").cast(IntegerType),
        col("_sup_bidder_advertiser_pb_LOOKUP"),
        col("_sup_bidder_advertiser_pb_LOOKUP1")
      ).getField("advertiser_default_currency")
    ).when(
        is_not_null(col("agg_dw_clicks")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_clicks.buyer_member_id").cast(IntegerType),
          col("agg_dw_clicks.seller_member_id").cast(IntegerType),
          col("agg_dw_clicks.advertiser_id").cast(IntegerType),
          col("agg_dw_clicks.imp_type").cast(IntegerType),
          col("_sup_bidder_advertiser_pb_LOOKUP2"),
          col("_sup_bidder_advertiser_pb_LOOKUP3")
        ).getField("advertiser_default_currency")
      )
      .when(
        is_not_null(col("agg_dw_video_events")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_video_events.buyer_member_id").cast(IntegerType),
          col("agg_dw_video_events.seller_member_id").cast(IntegerType),
          col("agg_dw_video_events.advertiser_id").cast(IntegerType),
          coalesce(col("agg_dw_video_events.imp_type").cast(IntegerType),
                   col("agg_dw_video_events.request_imp_type").cast(IntegerType)
          ),
          col("_sup_bidder_advertiser_pb_LOOKUP4"),
          col("_sup_bidder_advertiser_pb_LOOKUP5")
        ).getField("advertiser_default_currency")
      )
      .otherwise(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          f_currency_mapper(
            f_calc_derived_fields(
              col("agg_dw_video_events"),
              col("agg_platform_video_impressions"),
              col("agg_platform_video_requests"),
              col("agg_dw_clicks"),
              col("agg_dw_pixels"),
              f_get_winning_creative_id(col("agg_dw_video_events"),
                                        col("agg_platform_video_impressions")
              ).cast(IntegerType),
              lit(Config.XR_BUSINESS_DATE),
              lit(Config.XR_BUSINESS_HOUR)
            ).getField("fx_rate_snapshot_id"),
            col("agg_platform_video_impressions.buyer_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.seller_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.advertiser_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.imp_type").cast(IntegerType),
            col("_sup_bidder_advertiser_pb_LOOKUP6"),
            col("_sup_bidder_advertiser_pb_LOOKUP7")
          ).getField("advertiser_default_currency")
        )
      )
  }

  def member_currency(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    when(
      is_not_null(col("agg_dw_pixels")).cast(BooleanType),
      f_currency_mapper(
        f_calc_derived_fields(
          col("agg_dw_video_events"),
          col("agg_platform_video_impressions"),
          col("agg_platform_video_requests"),
          col("agg_dw_clicks"),
          col("agg_dw_pixels"),
          f_get_winning_creative_id(col("agg_dw_video_events"),
                                    col("agg_platform_video_impressions")
          ).cast(IntegerType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).getField("fx_rate_snapshot_id"),
        col("agg_dw_pixels.buyer_member_id").cast(IntegerType),
        col("agg_dw_pixels.seller_member_id").cast(IntegerType),
        col("agg_dw_pixels.advertiser_id").cast(IntegerType),
        col("agg_dw_pixels.imp_type").cast(IntegerType),
        col("_sup_bidder_advertiser_pb_LOOKUP"),
        col("_sup_bidder_advertiser_pb_LOOKUP1")
      ).getField("member_currency")
    ).when(
        is_not_null(col("agg_dw_clicks")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_clicks.buyer_member_id").cast(IntegerType),
          col("agg_dw_clicks.seller_member_id").cast(IntegerType),
          col("agg_dw_clicks.advertiser_id").cast(IntegerType),
          col("agg_dw_clicks.imp_type").cast(IntegerType),
          col("_sup_bidder_advertiser_pb_LOOKUP2"),
          col("_sup_bidder_advertiser_pb_LOOKUP3")
        ).getField("member_currency")
      )
      .when(
        is_not_null(col("agg_dw_video_events")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_video_events.buyer_member_id").cast(IntegerType),
          col("agg_dw_video_events.seller_member_id").cast(IntegerType),
          col("agg_dw_video_events.advertiser_id").cast(IntegerType),
          coalesce(col("agg_dw_video_events.imp_type").cast(IntegerType),
                   col("agg_dw_video_events.request_imp_type").cast(IntegerType)
          ),
          col("_sup_bidder_advertiser_pb_LOOKUP4"),
          col("_sup_bidder_advertiser_pb_LOOKUP5")
        ).getField("member_currency")
      )
      .otherwise(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          f_currency_mapper(
            f_calc_derived_fields(
              col("agg_dw_video_events"),
              col("agg_platform_video_impressions"),
              col("agg_platform_video_requests"),
              col("agg_dw_clicks"),
              col("agg_dw_pixels"),
              f_get_winning_creative_id(col("agg_dw_video_events"),
                                        col("agg_platform_video_impressions")
              ).cast(IntegerType),
              lit(Config.XR_BUSINESS_DATE),
              lit(Config.XR_BUSINESS_HOUR)
            ).getField("fx_rate_snapshot_id"),
            col("agg_platform_video_impressions.buyer_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.seller_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.advertiser_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.imp_type").cast(IntegerType),
            col("_sup_bidder_advertiser_pb_LOOKUP6"),
            col("_sup_bidder_advertiser_pb_LOOKUP7")
          ).getField("member_currency")
        )
      )
  }

  def billing_exchange_rate(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    when(
      is_not_null(col("agg_dw_pixels")).cast(BooleanType),
      f_currency_mapper(
        f_calc_derived_fields(
          col("agg_dw_video_events"),
          col("agg_platform_video_impressions"),
          col("agg_platform_video_requests"),
          col("agg_dw_clicks"),
          col("agg_dw_pixels"),
          f_get_winning_creative_id(col("agg_dw_video_events"),
                                    col("agg_platform_video_impressions")
          ).cast(IntegerType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).getField("fx_rate_snapshot_id"),
        col("agg_dw_pixels.buyer_member_id").cast(IntegerType),
        col("agg_dw_pixels.seller_member_id").cast(IntegerType),
        col("agg_dw_pixels.advertiser_id").cast(IntegerType),
        col("agg_dw_pixels.imp_type").cast(IntegerType),
        col("_sup_bidder_advertiser_pb_LOOKUP"),
        col("_sup_bidder_advertiser_pb_LOOKUP1")
      ).getField("billing_exchange_rate")
    ).when(
        is_not_null(col("agg_dw_clicks")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_clicks.buyer_member_id").cast(IntegerType),
          col("agg_dw_clicks.seller_member_id").cast(IntegerType),
          col("agg_dw_clicks.advertiser_id").cast(IntegerType),
          col("agg_dw_clicks.imp_type").cast(IntegerType),
          col("_sup_bidder_advertiser_pb_LOOKUP2"),
          col("_sup_bidder_advertiser_pb_LOOKUP3")
        ).getField("billing_exchange_rate")
      )
      .when(
        is_not_null(col("agg_dw_video_events")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_video_events.buyer_member_id").cast(IntegerType),
          col("agg_dw_video_events.seller_member_id").cast(IntegerType),
          col("agg_dw_video_events.advertiser_id").cast(IntegerType),
          coalesce(col("agg_dw_video_events.imp_type").cast(IntegerType),
                   col("agg_dw_video_events.request_imp_type").cast(IntegerType)
          ),
          col("_sup_bidder_advertiser_pb_LOOKUP4"),
          col("_sup_bidder_advertiser_pb_LOOKUP5")
        ).getField("billing_exchange_rate")
      )
      .otherwise(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          f_currency_mapper(
            f_calc_derived_fields(
              col("agg_dw_video_events"),
              col("agg_platform_video_impressions"),
              col("agg_platform_video_requests"),
              col("agg_dw_clicks"),
              col("agg_dw_pixels"),
              f_get_winning_creative_id(col("agg_dw_video_events"),
                                        col("agg_platform_video_impressions")
              ).cast(IntegerType),
              lit(Config.XR_BUSINESS_DATE),
              lit(Config.XR_BUSINESS_HOUR)
            ).getField("fx_rate_snapshot_id"),
            col("agg_platform_video_impressions.buyer_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.seller_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.advertiser_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.imp_type").cast(IntegerType),
            col("_sup_bidder_advertiser_pb_LOOKUP6"),
            col("_sup_bidder_advertiser_pb_LOOKUP7")
          ).getField("billing_exchange_rate")
        )
      )
      .cast(DoubleType)
  }

  def billing_currency(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    when(
      is_not_null(col("agg_dw_pixels")).cast(BooleanType),
      f_currency_mapper(
        f_calc_derived_fields(
          col("agg_dw_video_events"),
          col("agg_platform_video_impressions"),
          col("agg_platform_video_requests"),
          col("agg_dw_clicks"),
          col("agg_dw_pixels"),
          f_get_winning_creative_id(col("agg_dw_video_events"),
                                    col("agg_platform_video_impressions")
          ).cast(IntegerType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).getField("fx_rate_snapshot_id"),
        col("agg_dw_pixels.buyer_member_id").cast(IntegerType),
        col("agg_dw_pixels.seller_member_id").cast(IntegerType),
        col("agg_dw_pixels.advertiser_id").cast(IntegerType),
        col("agg_dw_pixels.imp_type").cast(IntegerType),
        col("_sup_bidder_advertiser_pb_LOOKUP"),
        col("_sup_bidder_advertiser_pb_LOOKUP1")
      ).getField("billing_currency")
    ).when(
        is_not_null(col("agg_dw_clicks")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_clicks.buyer_member_id").cast(IntegerType),
          col("agg_dw_clicks.seller_member_id").cast(IntegerType),
          col("agg_dw_clicks.advertiser_id").cast(IntegerType),
          col("agg_dw_clicks.imp_type").cast(IntegerType),
          col("_sup_bidder_advertiser_pb_LOOKUP2"),
          col("_sup_bidder_advertiser_pb_LOOKUP3")
        ).getField("billing_currency")
      )
      .when(
        is_not_null(col("agg_dw_video_events")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_video_events.buyer_member_id").cast(IntegerType),
          col("agg_dw_video_events.seller_member_id").cast(IntegerType),
          col("agg_dw_video_events.advertiser_id").cast(IntegerType),
          coalesce(col("agg_dw_video_events.imp_type").cast(IntegerType),
                   col("agg_dw_video_events.request_imp_type").cast(IntegerType)
          ),
          col("_sup_bidder_advertiser_pb_LOOKUP4"),
          col("_sup_bidder_advertiser_pb_LOOKUP5")
        ).getField("billing_currency")
      )
      .otherwise(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          f_currency_mapper(
            f_calc_derived_fields(
              col("agg_dw_video_events"),
              col("agg_platform_video_impressions"),
              col("agg_platform_video_requests"),
              col("agg_dw_clicks"),
              col("agg_dw_pixels"),
              f_get_winning_creative_id(col("agg_dw_video_events"),
                                        col("agg_platform_video_impressions")
              ).cast(IntegerType),
              lit(Config.XR_BUSINESS_DATE),
              lit(Config.XR_BUSINESS_HOUR)
            ).getField("fx_rate_snapshot_id"),
            col("agg_platform_video_impressions.buyer_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.seller_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.advertiser_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.imp_type").cast(IntegerType),
            col("_sup_bidder_advertiser_pb_LOOKUP6"),
            col("_sup_bidder_advertiser_pb_LOOKUP7")
          ).getField("billing_currency")
        )
      )
  }

  def member_exchange_rate(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    when(
      is_not_null(col("agg_dw_pixels")).cast(BooleanType),
      f_currency_mapper(
        f_calc_derived_fields(
          col("agg_dw_video_events"),
          col("agg_platform_video_impressions"),
          col("agg_platform_video_requests"),
          col("agg_dw_clicks"),
          col("agg_dw_pixels"),
          f_get_winning_creative_id(col("agg_dw_video_events"),
                                    col("agg_platform_video_impressions")
          ).cast(IntegerType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).getField("fx_rate_snapshot_id"),
        col("agg_dw_pixels.buyer_member_id").cast(IntegerType),
        col("agg_dw_pixels.seller_member_id").cast(IntegerType),
        col("agg_dw_pixels.advertiser_id").cast(IntegerType),
        col("agg_dw_pixels.imp_type").cast(IntegerType),
        col("_sup_bidder_advertiser_pb_LOOKUP"),
        col("_sup_bidder_advertiser_pb_LOOKUP1")
      ).getField("member_exchange_rate")
    ).when(
        is_not_null(col("agg_dw_clicks")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_clicks.buyer_member_id").cast(IntegerType),
          col("agg_dw_clicks.seller_member_id").cast(IntegerType),
          col("agg_dw_clicks.advertiser_id").cast(IntegerType),
          col("agg_dw_clicks.imp_type").cast(IntegerType),
          col("_sup_bidder_advertiser_pb_LOOKUP2"),
          col("_sup_bidder_advertiser_pb_LOOKUP3")
        ).getField("member_exchange_rate")
      )
      .when(
        is_not_null(col("agg_dw_video_events")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_video_events.buyer_member_id").cast(IntegerType),
          col("agg_dw_video_events.seller_member_id").cast(IntegerType),
          col("agg_dw_video_events.advertiser_id").cast(IntegerType),
          coalesce(col("agg_dw_video_events.imp_type").cast(IntegerType),
                   col("agg_dw_video_events.request_imp_type").cast(IntegerType)
          ),
          col("_sup_bidder_advertiser_pb_LOOKUP4"),
          col("_sup_bidder_advertiser_pb_LOOKUP5")
        ).getField("member_exchange_rate")
      )
      .otherwise(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          f_currency_mapper(
            f_calc_derived_fields(
              col("agg_dw_video_events"),
              col("agg_platform_video_impressions"),
              col("agg_platform_video_requests"),
              col("agg_dw_clicks"),
              col("agg_dw_pixels"),
              f_get_winning_creative_id(col("agg_dw_video_events"),
                                        col("agg_platform_video_impressions")
              ).cast(IntegerType),
              lit(Config.XR_BUSINESS_DATE),
              lit(Config.XR_BUSINESS_HOUR)
            ).getField("fx_rate_snapshot_id"),
            col("agg_platform_video_impressions.buyer_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.seller_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.advertiser_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.imp_type").cast(IntegerType),
            col("_sup_bidder_advertiser_pb_LOOKUP6"),
            col("_sup_bidder_advertiser_pb_LOOKUP7")
          ).getField("member_exchange_rate")
        )
      )
      .cast(DoubleType)
  }

  def bidder_id(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    coalesce(
      when(
        coalesce(
          col("agg_platform_video_impressions.bidder_id").cast(IntegerType),
          lit(0)
        ) =!= lit(0),
        col("agg_platform_video_impressions.bidder_id").cast(IntegerType)
      ).otherwise(
          when(
            coalesce(col("agg_platform_video_impressions.buyer_member_id")
                       .cast(IntegerType),
                     lit(0)
            ) =!= lit(0),
            lookup("sup_api_member_pb",
                   col("agg_platform_video_impressions.buyer_member_id")
                     .cast(IntegerType)
            ).getField("bidder_id")
          )
        )
        .cast(IntegerType),
      when(coalesce(col("agg_dw_clicks.bidder_id").cast(IntegerType),
                    lit(0)
           ) =!= lit(0),
           col("agg_dw_clicks.bidder_id").cast(IntegerType)
      ).otherwise(
          when(
            coalesce(col("agg_dw_clicks.buyer_member_id").cast(IntegerType),
                     lit(0)
            ) =!= lit(0),
            lookup("sup_api_member_pb",
                   col("agg_dw_clicks.buyer_member_id").cast(IntegerType)
            ).getField("bidder_id")
          )
        )
        .cast(IntegerType),
      when(coalesce(col("agg_dw_pixels.bidder_id").cast(IntegerType),
                    lit(0)
           ) =!= lit(0),
           col("agg_dw_pixels.bidder_id").cast(IntegerType)
      ).otherwise(
          when(
            coalesce(col("agg_dw_pixels.buyer_member_id").cast(IntegerType),
                     lit(0)
            ) =!= lit(0),
            lookup("sup_api_member_pb",
                   col("agg_dw_pixels.buyer_member_id").cast(IntegerType)
            ).getField("bidder_id")
          )
        )
        .cast(IntegerType),
      when(coalesce(col("agg_dw_video_events.bidder_id").cast(IntegerType),
                    lit(0)
           ) =!= lit(0),
           col("agg_dw_video_events.bidder_id").cast(IntegerType)
      ).when(
          coalesce(col("agg_dw_video_events.buyer_member_id").cast(IntegerType),
                   lit(0)
          ) =!= lit(0),
          lookup("sup_api_member_pb",
                 col("agg_dw_video_events.buyer_member_id").cast(IntegerType)
          ).getField("bidder_id")
        )
        .otherwise(lit(0))
        .cast(IntegerType),
      when(coalesce(col("agg_impbus_clicks.bidder_id").cast(IntegerType),
                    lit(0)
           ) =!= lit(0),
           col("agg_impbus_clicks.bidder_id").cast(IntegerType)
      ).otherwise(
          when(
            coalesce(col("agg_impbus_clicks.buyer_member_id").cast(IntegerType),
                     lit(0)
            ) =!= lit(0),
            lookup("sup_api_member_pb",
                   col("agg_impbus_clicks.buyer_member_id").cast(IntegerType)
            ).getField("bidder_id")
          )
        )
        .cast(IntegerType)
    )
  }

  def advertiser_default_exchange_rate(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    when(
      is_not_null(col("agg_dw_pixels")).cast(BooleanType),
      f_currency_mapper(
        f_calc_derived_fields(
          col("agg_dw_video_events"),
          col("agg_platform_video_impressions"),
          col("agg_platform_video_requests"),
          col("agg_dw_clicks"),
          col("agg_dw_pixels"),
          f_get_winning_creative_id(col("agg_dw_video_events"),
                                    col("agg_platform_video_impressions")
          ).cast(IntegerType),
          lit(Config.XR_BUSINESS_DATE),
          lit(Config.XR_BUSINESS_HOUR)
        ).getField("fx_rate_snapshot_id"),
        col("agg_dw_pixels.buyer_member_id").cast(IntegerType),
        col("agg_dw_pixels.seller_member_id").cast(IntegerType),
        col("agg_dw_pixels.advertiser_id").cast(IntegerType),
        col("agg_dw_pixels.imp_type").cast(IntegerType),
        col("_sup_bidder_advertiser_pb_LOOKUP"),
        col("_sup_bidder_advertiser_pb_LOOKUP1")
      ).getField("advertiser_default_exchange_rate")
    ).when(
        is_not_null(col("agg_dw_clicks")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_clicks.buyer_member_id").cast(IntegerType),
          col("agg_dw_clicks.seller_member_id").cast(IntegerType),
          col("agg_dw_clicks.advertiser_id").cast(IntegerType),
          col("agg_dw_clicks.imp_type").cast(IntegerType),
          col("_sup_bidder_advertiser_pb_LOOKUP2"),
          col("_sup_bidder_advertiser_pb_LOOKUP3")
        ).getField("advertiser_default_exchange_rate")
      )
      .when(
        is_not_null(col("agg_dw_video_events")).cast(BooleanType),
        f_currency_mapper(
          f_calc_derived_fields(
            col("agg_dw_video_events"),
            col("agg_platform_video_impressions"),
            col("agg_platform_video_requests"),
            col("agg_dw_clicks"),
            col("agg_dw_pixels"),
            f_get_winning_creative_id(col("agg_dw_video_events"),
                                      col("agg_platform_video_impressions")
            ).cast(IntegerType),
            lit(Config.XR_BUSINESS_DATE),
            lit(Config.XR_BUSINESS_HOUR)
          ).getField("fx_rate_snapshot_id"),
          col("agg_dw_video_events.buyer_member_id").cast(IntegerType),
          col("agg_dw_video_events.seller_member_id").cast(IntegerType),
          col("agg_dw_video_events.advertiser_id").cast(IntegerType),
          coalesce(col("agg_dw_video_events.imp_type").cast(IntegerType),
                   col("agg_dw_video_events.request_imp_type").cast(IntegerType)
          ),
          col("_sup_bidder_advertiser_pb_LOOKUP4"),
          col("_sup_bidder_advertiser_pb_LOOKUP5")
        ).getField("advertiser_default_exchange_rate")
      )
      .otherwise(
        when(
          is_not_null(col("agg_platform_video_impressions")).cast(BooleanType),
          f_currency_mapper(
            f_calc_derived_fields(
              col("agg_dw_video_events"),
              col("agg_platform_video_impressions"),
              col("agg_platform_video_requests"),
              col("agg_dw_clicks"),
              col("agg_dw_pixels"),
              f_get_winning_creative_id(col("agg_dw_video_events"),
                                        col("agg_platform_video_impressions")
              ).cast(IntegerType),
              lit(Config.XR_BUSINESS_DATE),
              lit(Config.XR_BUSINESS_HOUR)
            ).getField("fx_rate_snapshot_id"),
            col("agg_platform_video_impressions.buyer_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.seller_member_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.advertiser_id")
              .cast(IntegerType),
            col("agg_platform_video_impressions.imp_type").cast(IntegerType),
            col("_sup_bidder_advertiser_pb_LOOKUP6"),
            col("_sup_bidder_advertiser_pb_LOOKUP7")
          ).getField("advertiser_default_exchange_rate")
        )
      )
      .cast(DoubleType)
  }

  def region_id(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    coalesce(
      when(
        is_not_null(
          col("agg_platform_video_requests.region_id").cast(IntegerType)
        ).and(
          col("agg_platform_video_requests.region_id")
            .cast(IntegerType) =!= lit(0)
        ),
        col("agg_platform_video_requests.region_id").cast(IntegerType)
      ).cast(IntegerType),
      when(
        is_not_null(col("agg_dw_video_events.region_id").cast(IntegerType)).and(
          col("agg_dw_video_events.region_id").cast(IntegerType) =!= lit(0)
        ),
        col("agg_dw_video_events.region_id").cast(IntegerType)
      ).cast(IntegerType),
      when(
        is_not_null(
          col("agg_platform_video_impressions.region_id").cast(IntegerType)
        ).and(
          col("agg_platform_video_impressions.region_id")
            .cast(IntegerType) =!= lit(0)
        ),
        col("agg_platform_video_impressions.region_id").cast(IntegerType)
      ).cast(IntegerType),
      when(
        is_not_null(col("agg_dw_clicks.region_id").cast(IntegerType))
          .and(col("agg_dw_clicks.region_id").cast(IntegerType) =!= lit(0)),
        col("agg_dw_clicks.region_id").cast(IntegerType)
      ).cast(IntegerType),
      when(
        is_not_null(col("agg_dw_pixels.region_id").cast(IntegerType))
          .and(col("agg_dw_pixels.region_id").cast(IntegerType) =!= lit(0)),
        col("agg_dw_pixels.region_id").cast(IntegerType)
      ).cast(IntegerType),
      when(
        is_not_null(col("agg_impbus_clicks.region_id").cast(IntegerType))
          .and(col("agg_impbus_clicks.region_id").cast(IntegerType) =!= lit(0)),
        col("agg_impbus_clicks.region_id").cast(IntegerType)
      ).cast(IntegerType)
    )
  }

  def is_dw_buyer(context: Context) = {
    val spark  = context.spark
    val Config = context.config
    coalesce(
      when(
        coalesce(col("agg_dw_video_events.bidder_id").cast(IntegerType),
                 lit(0)
        ) =!= lit(0),
        when(col("agg_dw_video_events.bidder_id").cast(IntegerType) === lit(2),
             lit(1)
        ).otherwise(lit(0))
      ).otherwise(
          when(
            coalesce(
              col("agg_dw_video_events.buyer_member_id").cast(IntegerType),
              lit(0)
            ) =!= lit(0),
            when(coalesce(lookup("sup_api_member_pb",
                                 col("agg_dw_video_events.buyer_member_id")
                                   .cast(IntegerType)
                          ).getField("bidder_id"),
                          lit(0)
                 ) === lit(2),
                 lit(1)
            ).otherwise(lit(0))
          )
        )
        .cast(IntegerType),
      when(
        coalesce(
          col("agg_platform_video_impressions.bidder_id").cast(IntegerType),
          lit(0)
        ) =!= lit(0),
        when(col("agg_platform_video_impressions.bidder_id").cast(
               IntegerType
             ) === lit(2),
             lit(1)
        ).otherwise(lit(0))
      ).when(
          coalesce(col("agg_platform_video_impressions.buyer_member_id")
                     .cast(IntegerType),
                   lit(0)
          ) =!= lit(0),
          when(
            coalesce(lookup("sup_api_member_pb",
                            col(
                              "agg_platform_video_impressions.buyer_member_id"
                            ).cast(IntegerType)
                     ).getField("bidder_id"),
                     lit(0)
            ) === lit(2),
            lit(1)
          ).otherwise(lit(0))
        )
        .otherwise(lit(0))
        .cast(IntegerType)
    )
  }

}
