package io.prophecy.pipelines.first_agg_platform_video_analytics.graph.Main_Graph

import io.prophecy.libs._
import io.prophecy.pipelines.first_agg_platform_video_analytics.graph.Main_Graph.config.Context
import io.prophecy.pipelines.first_agg_platform_video_analytics.udfs.UDFs._
import io.prophecy.pipelines.first_agg_platform_video_analytics.udfs.ColumnFunctions._
import io.prophecy.pipelines.first_agg_platform_video_analytics.udfs.PipelineInitCode._
import org.apache.spark._
import org.apache.spark.sql._
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types._
import org.apache.spark.sql.expressions._
import java.time._

object spark_context_setup {
  def apply(context: Context, in0: DataFrame, in3: DataFrame, in4: DataFrame, in5: DataFrame): DataFrame = {
    val spark = context.spark
    val Config = context.config
    def agg_dw_clicks() = {
      when(
        is_not_null(col("in3.auction_id_64")).cast(BooleanType),
        struct(
          col("in3.date_time").as("date_time"),
          col("in3.auction_id_64").as("auction_id_64"),
          col("in3.user_id_64").as("user_id_64"),
          col("in3.tag_id").as("tag_id"),
          col("in3.venue_id").as("venue_id"),
          col("in3.inventory_source_id").as("inventory_source_id"),
          col("in3.session_frequency").as("session_frequency"),
          col("in3.width").as("width"),
          col("in3.height").as("height"),
          col("in3.geo_country").as("geo_country"),
          col("in3.geo_region").as("geo_region"),
          col("in3.gender").as("gender"),
          col("in3.age").as("age"),
          col("in3.seller_member_id").as("seller_member_id"),
          col("in3.buyer_member_id").as("buyer_member_id"),
          col("in3.creative_id").as("creative_id"),
          col("in3.seller_currency").as("seller_currency"),
          col("in3.buyer_currency").as("buyer_currency"),
          col("in3.advertiser_id").as("advertiser_id"),
          col("in3.campaign_group_id").as("campaign_group_id"),
          col("in3.campaign_id").as("campaign_id"),
          col("in3.creative_freq").as("creative_freq"),
          col("in3.creative_rec").as("creative_rec"),
          col("in3.is_learn").as("is_learn"),
          col("in3.is_remarketing").as("is_remarketing"),
          col("in3.advertiser_frequency").as("advertiser_frequency"),
          col("in3.advertiser_recency").as("advertiser_recency"),
          col("in3.user_group_id").as("user_group_id"),
          col("in3.camp_dp_id").as("camp_dp_id"),
          col("in3.media_buy_id").as("media_buy_id"),
          col("in3.brand_id").as("brand_id"),
          col("in3.is_appnexus_cleared").as("is_appnexus_cleared"),
          col("in3.clear_fees").as("clear_fees"),
          col("in3.media_buy_rev_share_pct").as("media_buy_rev_share_pct"),
          col("in3.revenue_value").as("revenue_value"),
          col("in3.pricing_type").as("pricing_type"),
          col("in3.site_id").as("site_id"),
          col("in3.content_category_id").as("content_category_id"),
          col("in3.fold_position").as("fold_position"),
          col("in3.external_inv_id").as("external_inv_id"),
          col("in3.cadence_modifier").as("cadence_modifier"),
          col("in3.predict_type").as("predict_type"),
          col("in3.predict_goal").as("predict_goal"),
          col("in3.imp_type").as("imp_type"),
          col("in3.advertiser_currency").as("advertiser_currency"),
          col("in3.advertiser_exchange_rate").as("advertiser_exchange_rate"),
          col("in3.ip_address").as("ip_address"),
          col("in3.pub_rule_id").as("pub_rule_id"),
          col("in3.publisher_id").as("publisher_id"),
          col("in3.insertion_order_id").as("insertion_order_id"),
          col("in3.predict_type_rev").as("predict_type_rev"),
          col("in3.predict_type_goal").as("predict_type_goal"),
          col("in3.predict_type_cost").as("predict_type_cost"),
          col("in3.booked_revenue_dollars").as("booked_revenue_dollars"),
          col("in3.booked_revenue_adv_curr").as("booked_revenue_adv_curr"),
          col("in3.commission_revshare").as("commission_revshare"),
          col("in3.serving_fees_revshare").as("serving_fees_revshare"),
          col("in3.user_tz_offset").as("user_tz_offset"),
          col("in3.media_type").as("media_type"),
          col("in3.operating_system").as("operating_system"),
          col("in3.browser").as("browser"),
          col("in3.language").as("language"),
          col("in3.publisher_currency").as("publisher_currency"),
          col("in3.publisher_exchange_rate").as("publisher_exchange_rate"),
          col("in3.media_cost_dollars_cpm").as("media_cost_dollars_cpm"),
          col("in3.site_domain").as("site_domain"),
          col("in3.payment_type").as("payment_type"),
          col("in3.revenue_type").as("revenue_type"),
          col("in3.bidder_id").as("bidder_id"),
          col("in3.inv_code").as("inv_code"),
          col("in3.application_id").as("application_id"),
          col("in3.is_control").as("is_control"),
          col("in3.vp_expose_domains").as("vp_expose_domains"),
          col("in3.vp_expose_categories").as("vp_expose_categories"),
          col("in3.vp_expose_pubs").as("vp_expose_pubs"),
          col("in3.vp_expose_tag").as("vp_expose_tag"),
          col("in3.vp_expose_age").as("vp_expose_age"),
          col("in3.vp_expose_gender").as("vp_expose_gender"),
          col("in3.inventory_url_id").as("inventory_url_id"),
          col("in3.imp_time").as("imp_time"),
          col("in3.is_exclusive").as("is_exclusive"),
          col("in3.truncate_ip").as("truncate_ip"),
          col("in3.datacenter_id").as("datacenter_id"),
          col("in3.device_id").as("device_id"),
          col("in3.carrier_id").as("carrier_id"),
          col("in3.creative_audit_status").as("creative_audit_status"),
          col("in3.is_creative_hosted").as("is_creative_hosted"),
          col("in3.auction_service_deduction").as("auction_service_deduction"),
          col("in3.auction_service_fees").as("auction_service_fees"),
          col("in3.seller_deduction").as("seller_deduction"),
          col("in3.city").as("city"),
          col("in3.latitude").as("latitude"),
          col("in3.longitude").as("longitude"),
          col("in3.device_unique_id").as("device_unique_id"),
          col("in3.targeted_segments").as("targeted_segments"),
          col("in3.supply_type").as("supply_type"),
          col("in3.is_toolbar").as("is_toolbar"),
          col("in3.control_pct").as("control_pct"),
          col("in3.deal_id").as("deal_id"),
          col("in3.vp_bitmap").as("vp_bitmap"),
          col("in3.ozone_id").as("ozone_id"),
          col("in3.is_performance").as("is_performance"),
          col("in3.sdk_version").as("sdk_version"),
          col("in3.device_type").as("device_type"),
          col("in3.dma").as("dma"),
          col("in3.postal").as("postal"),
          col("in3.package_id").as("package_id"),
          col("in3.campaign_group_freq").as("campaign_group_freq"),
          col("in3.campaign_group_rec").as("campaign_group_rec"),
          col("in3.insertion_order_freq").as("insertion_order_freq"),
          col("in3.insertion_order_rec").as("insertion_order_rec"),
          col("in3.buyer_gender").as("buyer_gender"),
          col("in3.buyer_age").as("buyer_age"),
          col("in3.targeted_segment_list").as("targeted_segment_list"),
          col("in3.custom_model_id").as("custom_model_id"),
          col("in3.custom_model_last_modified").as("custom_model_last_modified"),
          col("in3.custom_model_output_code").as("custom_model_output_code"),
          col("in3.external_uid").as("external_uid"),
          col("in3.request_uuid").as("request_uuid"),
          col("in3.mobile_app_instance_id").as("mobile_app_instance_id"),
          col("in3.traffic_source_code").as("traffic_source_code"),
          col("in3.external_request_id").as("external_request_id"),
          col("in3.stitch_group_id").as("stitch_group_id"),
          col("in3.deal_type").as("deal_type"),
          col("in3.ym_floor_id").as("ym_floor_id"),
          col("in3.ym_bias_id").as("ym_bias_id"),
          col("in3.bid_priority").as("bid_priority"),
          col("in3.viewdef_definition_id").as("viewdef_definition_id"),
          col("in3.buyer_charges").as("buyer_charges"),
          col("in3.seller_charges").as("seller_charges"),
          col("in3.view_result").as("view_result"),
          col("in3.view_non_measurable_reason").as("view_non_measurable_reason"),
          col("in3.view_detection_enabled").as("view_detection_enabled"),
          col("in3.data_costs").as("data_costs"),
          col("in3.device_make_id").as("device_make_id"),
          col("in3.operating_system_family_id").as("operating_system_family_id"),
          col("in3.pricing_media_type").as("pricing_media_type"),
          col("in3.buyer_trx_event_id").as("buyer_trx_event_id"),
          col("in3.seller_trx_event_id").as("seller_trx_event_id"),
          col("in3.is_unit_of_trx").as("is_unit_of_trx"),
          col("in3.revenue_auction_event_type").as("revenue_auction_event_type"),
          col("in3.is_prebid").as("is_prebid"),
          col("in3.auction_timestamp").as("auction_timestamp"),
          col("in3.two_phase_reduction_applied")
            .as("two_phase_reduction_applied"),
          col("in3.region_id").as("region_id"),
          col("in3.media_company_id").as("media_company_id"),
          col("in3.trade_agreement_id").as("trade_agreement_id"),
          col("in3.personal_data").as("personal_data"),
          col("in3.anonymized_user_info").as("anonymized_user_info"),
          col("in3.fx_rate_snapshot_id").as("fx_rate_snapshot_id"),
          col("in3.crossdevice_group_anon").as("crossdevice_group_anon"),
          col("in3.revenue_event_type_id").as("revenue_event_type_id"),
          col("in3.external_creative_id").as("external_creative_id"),
          col("in3.targeted_segment_details").as("targeted_segment_details"),
          col("in3.bidder_seat_id").as("bidder_seat_id"),
          col("in3.is_curated").as("is_curated"),
          col("in3.curator_member_id").as("curator_member_id"),
          col("in3.cold_start_price_type").as("cold_start_price_type"),
          col("in3.discovery_state").as("discovery_state"),
          col("in3.billing_period_id").as("billing_period_id"),
          col("in3.flight_id").as("flight_id"),
          col("in3.split_id").as("split_id"),
          col("in3.total_partner_fees_microcents")
            .as("total_partner_fees_microcents"),
          col("in3.net_buyer_spend").as("net_buyer_spend"),
          col("in3.net_media_cost_dollars_cpm").as("net_media_cost_dollars_cpm"),
          col("in3.total_data_costs_microcents")
            .as("total_data_costs_microcents"),
          col("in3.total_profit_microcents").as("total_profit_microcents"),
          col("in3.discovery_prediction").as("discovery_prediction"),
          col("in3.campaign_group_type_id").as("campaign_group_type_id"),
          col("in3.excluded_targeted_segment_details")
            .as("excluded_targeted_segment_details"),
          col("in3.trust_id").as("trust_id"),
          col("in3.predicted_kpi_event_rate").as("predicted_kpi_event_rate"),
          col("in3.has_crossdevice_reach_extension")
            .as("has_crossdevice_reach_extension"),
          col("in3.total_segment_data_costs_microcents")
            .as("total_segment_data_costs_microcents"),
          col("in3.total_feature_costs_microcents")
            .as("total_feature_costs_microcents"),
          col("in3.counterparty_ruleset_type").as("counterparty_ruleset_type"),
          col("in3.log_product_ads").as("log_product_ads"),
          col("in3.hb_source").as("hb_source"),
          col("in3.buyer_line_item_currency").as("buyer_line_item_currency"),
          col("in3.deal_line_item_currency").as("deal_line_item_currency"),
          col("in3.personal_identifiers_experimental")
            .as("personal_identifiers_experimental"),
          col("in3.postal_code_ext_id").as("postal_code_ext_id"),
          col("in3.targeted_segment_details_by_id_type")
            .as("targeted_segment_details_by_id_type"),
          col("in3.personal_identifiers").as("personal_identifiers"),
          col("in3.is_residential_ip").as("is_residential_ip"),
          col("in3.hashed_ip").as("hashed_ip"),
          col("in3.district_postal_code_lists").as("district_postal_code_lists"),
          col("in3.buyer_dpvp_bitmap").as("buyer_dpvp_bitmap"),
          col("in3.seller_dpvp_bitmap").as("seller_dpvp_bitmap"),
          col("in3.private_auction_eligible").as("private_auction_eligible"),
          col("in3.chrome_traffic_label").as("chrome_traffic_label"),
          col("in3.is_private_auction").as("is_private_auction")
        )
      )
    }
    
    def agg_dw_pixels() = {
      when(
        is_not_null(col("in4.auction_id_64")).cast(BooleanType),
        struct(
          col("in4.date_time").as("date_time"),
          col("in4.auction_id_64").as("auction_id_64"),
          col("in4.user_id_64").as("user_id_64"),
          col("in4.tag_id").as("tag_id"),
          col("in4.venue_id").as("venue_id"),
          col("in4.inventory_source_id").as("inventory_source_id"),
          col("in4.session_frequency").as("session_frequency"),
          col("in4.width").as("width"),
          col("in4.height").as("height"),
          col("in4.geo_country").as("geo_country"),
          col("in4.geo_region").as("geo_region"),
          col("in4.gender").as("gender"),
          col("in4.age").as("age"),
          col("in4.seller_member_id").as("seller_member_id"),
          col("in4.buyer_member_id").as("buyer_member_id"),
          col("in4.creative_id").as("creative_id"),
          col("in4.seller_currency").as("seller_currency"),
          col("in4.buyer_currency").as("buyer_currency"),
          col("in4.advertiser_id").as("advertiser_id"),
          col("in4.campaign_group_id").as("campaign_group_id"),
          col("in4.campaign_id").as("campaign_id"),
          col("in4.creative_freq").as("creative_freq"),
          col("in4.creative_rec").as("creative_rec"),
          col("in4.is_learn").as("is_learn"),
          col("in4.is_remarketing").as("is_remarketing"),
          col("in4.advertiser_frequency").as("advertiser_frequency"),
          col("in4.advertiser_recency").as("advertiser_recency"),
          col("in4.user_group_id").as("user_group_id"),
          col("in4.camp_dp_id").as("camp_dp_id"),
          col("in4.media_buy_id").as("media_buy_id"),
          col("in4.post_click_conv").as("post_click_conv"),
          col("in4.post_view_conv").as("post_view_conv"),
          col("in4.post_click_revenue").as("post_click_revenue"),
          col("in4.post_view_revenue").as("post_view_revenue"),
          col("in4.brand_id").as("brand_id"),
          col("in4.is_appnexus_cleared").as("is_appnexus_cleared"),
          col("in4.clear_fees").as("clear_fees"),
          col("in4.media_buy_rev_share_pct").as("media_buy_rev_share_pct"),
          col("in4.revenue_value").as("revenue_value"),
          col("in4.pricing_type").as("pricing_type"),
          col("in4.imp_time").as("imp_time"),
          col("in4.pixel_id").as("pixel_id"),
          col("in4.booked_revenue").as("booked_revenue"),
          col("in4.site_id").as("site_id"),
          col("in4.content_category_id").as("content_category_id"),
          col("in4.fold_position").as("fold_position"),
          col("in4.external_inv_id").as("external_inv_id"),
          col("in4.cadence_modifier").as("cadence_modifier"),
          col("in4.predict_goal").as("predict_goal"),
          col("in4.imp_type").as("imp_type"),
          col("in4.advertiser_currency").as("advertiser_currency"),
          col("in4.advertiser_exchange_rate").as("advertiser_exchange_rate"),
          col("in4.ip_address").as("ip_address"),
          col("in4.order_id").as("order_id"),
          col("in4.external_data").as("external_data"),
          col("in4.pub_rule_id").as("pub_rule_id"),
          col("in4.publisher_id").as("publisher_id"),
          col("in4.insertion_order_id").as("insertion_order_id"),
          col("in4.predict_type_rev").as("predict_type_rev"),
          col("in4.predict_type_goal").as("predict_type_goal"),
          col("in4.predict_type_cost").as("predict_type_cost"),
          col("in4.booked_revenue_dollars").as("booked_revenue_dollars"),
          col("in4.booked_revenue_adv_curr").as("booked_revenue_adv_curr"),
          col("in4.commission_revshare").as("commission_revshare"),
          col("in4.serving_fees_revshare").as("serving_fees_revshare"),
          col("in4.is_control").as("is_control"),
          col("in4.user_tz_offset").as("user_tz_offset"),
          col("in4.media_type").as("media_type"),
          col("in4.operating_system").as("operating_system"),
          col("in4.browser").as("browser"),
          col("in4.language").as("language"),
          col("in4.publisher_currency").as("publisher_currency"),
          col("in4.publisher_exchange_rate").as("publisher_exchange_rate"),
          col("in4.media_cost_dollars_cpm").as("media_cost_dollars_cpm"),
          col("in4.site_domain").as("site_domain"),
          col("in4.payment_type").as("payment_type"),
          col("in4.revenue_type").as("revenue_type"),
          col("in4.datacenter_id").as("datacenter_id"),
          col("in4.vp_expose_domains").as("vp_expose_domains"),
          col("in4.vp_expose_categories").as("vp_expose_categories"),
          col("in4.vp_expose_pubs").as("vp_expose_pubs"),
          col("in4.vp_expose_tag").as("vp_expose_tag"),
          col("in4.vp_expose_age").as("vp_expose_age"),
          col("in4.vp_expose_gender").as("vp_expose_gender"),
          col("in4.inventory_url_id").as("inventory_url_id"),
          col("in4.is_exclusive").as("is_exclusive"),
          col("in4.truncate_ip").as("truncate_ip"),
          col("in4.device_id").as("device_id"),
          col("in4.carrier_id").as("carrier_id"),
          col("in4.creative_audit_status").as("creative_audit_status"),
          col("in4.is_creative_hosted").as("is_creative_hosted"),
          col("in4.auction_service_deduction").as("auction_service_deduction"),
          col("in4.auction_service_fees").as("auction_service_fees"),
          col("in4.seller_deduction").as("seller_deduction"),
          col("in4.city").as("city"),
          col("in4.latitude").as("latitude"),
          col("in4.longitude").as("longitude"),
          col("in4.device_unique_id").as("device_unique_id"),
          col("in4.targeted_segments").as("targeted_segments"),
          col("in4.supply_type").as("supply_type"),
          col("in4.is_toolbar").as("is_toolbar"),
          col("in4.deal_id").as("deal_id"),
          col("in4.vp_bitmap").as("vp_bitmap"),
          col("in4.application_id").as("application_id"),
          col("in4.ozone_id").as("ozone_id"),
          col("in4.is_performance").as("is_performance"),
          col("in4.sdk_version").as("sdk_version"),
          col("in4.device_type").as("device_type"),
          col("in4.dma").as("dma"),
          col("in4.postal").as("postal"),
          col("in4.package_id").as("package_id"),
          col("in4.campaign_group_freq").as("campaign_group_freq"),
          col("in4.campaign_group_rec").as("campaign_group_rec"),
          col("in4.insertion_order_freq").as("insertion_order_freq"),
          col("in4.insertion_order_rec").as("insertion_order_rec"),
          col("in4.buyer_gender").as("buyer_gender"),
          col("in4.buyer_age").as("buyer_age"),
          col("in4.targeted_segment_list").as("targeted_segment_list"),
          col("in4.custom_model_id").as("custom_model_id"),
          col("in4.custom_model_last_modified").as("custom_model_last_modified"),
          col("in4.custom_model_output_code").as("custom_model_output_code"),
          col("in4.external_uid").as("external_uid"),
          col("in4.request_uuid").as("request_uuid"),
          col("in4.mobile_app_instance_id").as("mobile_app_instance_id"),
          col("in4.traffic_source_code").as("traffic_source_code"),
          col("in4.external_request_id").as("external_request_id"),
          col("in4.stitch_group_id").as("stitch_group_id"),
          col("in4.deal_type").as("deal_type"),
          col("in4.ym_floor_id").as("ym_floor_id"),
          col("in4.ym_bias_id").as("ym_bias_id"),
          col("in4.bid_priority").as("bid_priority"),
          col("in4.viewdef_definition_id").as("viewdef_definition_id"),
          col("in4.buyer_charges").as("buyer_charges"),
          col("in4.seller_charges").as("seller_charges"),
          col("in4.view_result").as("view_result"),
          col("in4.view_non_measurable_reason").as("view_non_measurable_reason"),
          col("in4.view_detection_enabled").as("view_detection_enabled"),
          col("in4.data_costs").as("data_costs"),
          col("in4.device_make_id").as("device_make_id"),
          col("in4.operating_system_family_id").as("operating_system_family_id"),
          col("in4.bidder_id").as("bidder_id"),
          col("in4.pricing_media_type").as("pricing_media_type"),
          col("in4.buyer_trx_event_id").as("buyer_trx_event_id"),
          col("in4.seller_trx_event_id").as("seller_trx_event_id"),
          col("in4.is_unit_of_trx").as("is_unit_of_trx"),
          col("in4.revenue_auction_event_type").as("revenue_auction_event_type"),
          col("in4.is_prebid").as("is_prebid"),
          col("in4.attribution_context").as("attribution_context"),
          col("in4.two_phase_reduction_applied")
            .as("two_phase_reduction_applied"),
          col("in4.region_id").as("region_id"),
          col("in4.media_company_id").as("media_company_id"),
          col("in4.trade_agreement_id").as("trade_agreement_id"),
          col("in4.personal_data").as("personal_data"),
          col("in4.anonymized_user_info").as("anonymized_user_info"),
          col("in4.auction_timestamp").as("auction_timestamp"),
          col("in4.fx_rate_snapshot_id").as("fx_rate_snapshot_id"),
          col("in4.crossdevice_group_anon").as("crossdevice_group_anon"),
          col("in4.post_click_crossdevice_conv")
            .as("post_click_crossdevice_conv"),
          col("in4.post_view_crossdevice_conv").as("post_view_crossdevice_conv"),
          col("in4.revenue_event_type_id").as("revenue_event_type_id"),
          col("in4.post_click_crossdevice_revenue")
            .as("post_click_crossdevice_revenue"),
          col("in4.post_view_crossdevice_revenue")
            .as("post_view_crossdevice_revenue"),
          col("in4.external_creative_id").as("external_creative_id"),
          col("in4.targeted_segment_details").as("targeted_segment_details"),
          col("in4.bidder_seat_id").as("bidder_seat_id"),
          col("in4.universal_pixel_rule_version_id")
            .as("universal_pixel_rule_version_id"),
          col("in4.is_curated").as("is_curated"),
          col("in4.curator_member_id").as("curator_member_id"),
          col("in4.cold_start_price_type").as("cold_start_price_type"),
          col("in4.discovery_state").as("discovery_state"),
          col("in4.billing_period_id").as("billing_period_id"),
          col("in4.flight_id").as("flight_id"),
          col("in4.split_id").as("split_id"),
          col("in4.conversion_device_type").as("conversion_device_type"),
          col("in4.conversion_device_make_id").as("conversion_device_make_id"),
          col("in4.universal_pixel_fire_id").as("universal_pixel_fire_id"),
          col("in4.discovery_prediction").as("discovery_prediction"),
          col("in4.campaign_group_type_id").as("campaign_group_type_id"),
          col("in4.excluded_targeted_segment_details")
            .as("excluded_targeted_segment_details"),
          col("in4.trust_id").as("trust_id"),
          col("in4.predicted_kpi_event_rate").as("predicted_kpi_event_rate"),
          col("in4.has_crossdevice_reach_extension")
            .as("has_crossdevice_reach_extension"),
          col("in4.counterparty_ruleset_type").as("counterparty_ruleset_type"),
          col("in4.log_product_ads").as("log_product_ads"),
          col("in4.hb_source").as("hb_source"),
          col("in4.personal_identifiers_experimental")
            .as("personal_identifiers_experimental"),
          col("in4.postal_code_ext_id").as("postal_code_ext_id"),
          col("in4.targeted_segment_details_by_id_type")
            .as("targeted_segment_details_by_id_type"),
          col("in4.personal_identifiers").as("personal_identifiers"),
          col("in4.post_click_ip_conv").as("post_click_ip_conv"),
          col("in4.post_view_ip_conv").as("post_view_ip_conv"),
          col("in4.hashed_ip").as("hashed_ip"),
          col("in4.district_postal_code_lists").as("district_postal_code_lists"),
          col("in4.buyer_dpvp_bitmap").as("buyer_dpvp_bitmap"),
          col("in4.seller_dpvp_bitmap").as("seller_dpvp_bitmap"),
          col("in4.private_auction_eligible").as("private_auction_eligible"),
          col("in4.chrome_traffic_label").as("chrome_traffic_label"),
          col("in4.is_private_auction").as("is_private_auction")
        )
      )
    }
    
    def agg_impbus_clicks() = {
      when(
        is_not_null(col("in5.auction_id_64")).cast(BooleanType),
        struct(
          col("in5.date_time").as("date_time"),
          col("in5.auction_id_64").as("auction_id_64"),
          col("in5.user_id_64").as("user_id_64"),
          col("in5.tag_id").as("tag_id"),
          col("in5.venue_id").as("venue_id"),
          col("in5.inventory_source_id").as("inventory_source_id"),
          col("in5.session_frequency").as("session_frequency"),
          col("in5.width").as("width"),
          col("in5.height").as("height"),
          col("in5.geo_country").as("geo_country"),
          col("in5.geo_region").as("geo_region"),
          col("in5.gender").as("gender"),
          col("in5.age").as("age"),
          col("in5.seller_member_id").as("seller_member_id"),
          col("in5.buyer_member_id").as("buyer_member_id"),
          col("in5.creative_id").as("creative_id"),
          col("in5.seller_currency").as("seller_currency"),
          col("in5.buyer_currency").as("buyer_currency"),
          col("in5.advertiser_id").as("advertiser_id"),
          col("in5.campaign_group_id").as("campaign_group_id"),
          col("in5.campaign_id").as("campaign_id"),
          col("in5.creative_freq").as("creative_freq"),
          col("in5.creative_rec").as("creative_rec"),
          col("in5.is_learn").as("is_learn"),
          col("in5.is_remarketing").as("is_remarketing"),
          col("in5.advertiser_frequency").as("advertiser_frequency"),
          col("in5.advertiser_recency").as("advertiser_recency"),
          col("in5.user_group_id").as("user_group_id"),
          col("in5.camp_dp_id").as("camp_dp_id"),
          col("in5.media_buy_id").as("media_buy_id"),
          col("in5.brand_id").as("brand_id"),
          col("in5.is_appnexus_cleared").as("is_appnexus_cleared"),
          col("in5.clear_fees").as("clear_fees"),
          col("in5.media_buy_rev_share_pct").as("media_buy_rev_share_pct"),
          col("in5.revenue_value").as("revenue_value"),
          col("in5.pricing_type").as("pricing_type"),
          col("in5.site_id").as("site_id"),
          col("in5.content_category_id").as("content_category_id"),
          col("in5.fold_position").as("fold_position"),
          col("in5.external_inv_id").as("external_inv_id"),
          col("in5.cadence_modifier").as("cadence_modifier"),
          col("in5.imp_type").as("imp_type"),
          col("in5.advertiser_currency").as("advertiser_currency"),
          col("in5.advertiser_exchange_rate").as("advertiser_exchange_rate"),
          col("in5.ip_address").as("ip_address"),
          col("in5.pub_rule_id").as("pub_rule_id"),
          col("in5.publisher_id").as("publisher_id"),
          col("in5.insertion_order_id").as("insertion_order_id"),
          col("in5.predict_type_rev").as("predict_type_rev"),
          col("in5.predict_type_goal").as("predict_type_goal"),
          col("in5.predict_type_cost").as("predict_type_cost"),
          col("in5.commission_revshare").as("commission_revshare"),
          col("in5.serving_fees_revshare").as("serving_fees_revshare"),
          col("in5.user_tz_offset").as("user_tz_offset"),
          col("in5.media_type").as("media_type"),
          col("in5.operating_system").as("operating_system"),
          col("in5.browser").as("browser"),
          col("in5.language").as("language"),
          col("in5.publisher_currency").as("publisher_currency"),
          col("in5.publisher_exchange_rate").as("publisher_exchange_rate"),
          col("in5.site_domain").as("site_domain"),
          col("in5.payment_type").as("payment_type"),
          col("in5.revenue_type").as("revenue_type"),
          col("in5.bidder_id").as("bidder_id"),
          col("in5.inv_code").as("inv_code"),
          col("in5.application_id").as("application_id"),
          col("in5.is_control").as("is_control"),
          col("in5.vp_expose_domains").as("vp_expose_domains"),
          col("in5.vp_expose_categories").as("vp_expose_categories"),
          col("in5.vp_expose_pubs").as("vp_expose_pubs"),
          col("in5.vp_expose_tag").as("vp_expose_tag"),
          col("in5.vp_expose_age").as("vp_expose_age"),
          col("in5.vp_expose_gender").as("vp_expose_gender"),
          col("in5.inventory_url_id").as("inventory_url_id"),
          col("in5.imp_time").as("imp_time"),
          col("in5.is_exclusive").as("is_exclusive"),
          col("in5.truncate_ip").as("truncate_ip"),
          col("in5.datacenter_id").as("datacenter_id"),
          col("in5.device_id").as("device_id"),
          col("in5.carrier_id").as("carrier_id"),
          col("in5.creative_audit_status").as("creative_audit_status"),
          col("in5.is_creative_hosted").as("is_creative_hosted"),
          col("in5.city").as("city"),
          col("in5.latitude").as("latitude"),
          col("in5.longitude").as("longitude"),
          col("in5.device_unique_id").as("device_unique_id"),
          col("in5.targeted_segments").as("targeted_segments"),
          col("in5.supply_type").as("supply_type"),
          col("in5.is_toolbar").as("is_toolbar"),
          col("in5.control_pct").as("control_pct"),
          col("in5.deal_id").as("deal_id"),
          col("in5.vp_bitmap").as("vp_bitmap"),
          col("in5.ozone_id").as("ozone_id"),
          col("in5.is_performance").as("is_performance"),
          col("in5.sdk_version").as("sdk_version"),
          col("in5.device_type").as("device_type"),
          col("in5.dma").as("dma"),
          col("in5.postal").as("postal"),
          col("in5.package_id").as("package_id"),
          col("in5.campaign_group_freq").as("campaign_group_freq"),
          col("in5.campaign_group_rec").as("campaign_group_rec"),
          col("in5.insertion_order_freq").as("insertion_order_freq"),
          col("in5.insertion_order_rec").as("insertion_order_rec"),
          col("in5.buyer_gender").as("buyer_gender"),
          col("in5.buyer_age").as("buyer_age"),
          col("in5.targeted_segment_list").as("targeted_segment_list"),
          col("in5.custom_model_id").as("custom_model_id"),
          col("in5.custom_model_last_modified").as("custom_model_last_modified"),
          col("in5.custom_model_output_code").as("custom_model_output_code"),
          col("in5.external_uid").as("external_uid"),
          col("in5.request_uuid").as("request_uuid"),
          col("in5.mobile_app_instance_id").as("mobile_app_instance_id"),
          col("in5.traffic_source_code").as("traffic_source_code"),
          col("in5.external_request_id").as("external_request_id"),
          col("in5.stitch_group_id").as("stitch_group_id"),
          col("in5.deal_type").as("deal_type"),
          col("in5.ym_floor_id").as("ym_floor_id"),
          col("in5.ym_bias_id").as("ym_bias_id"),
          col("in5.bid_priority").as("bid_priority"),
          col("in5.viewdef_definition_id").as("viewdef_definition_id"),
          col("in5.view_result").as("view_result"),
          col("in5.view_non_measurable_reason").as("view_non_measurable_reason"),
          col("in5.view_detection_enabled").as("view_detection_enabled"),
          col("in5.device_make_id").as("device_make_id"),
          col("in5.operating_system_family_id").as("operating_system_family_id"),
          col("in5.pricing_media_type").as("pricing_media_type"),
          col("in5.buyer_trx_event_id").as("buyer_trx_event_id"),
          col("in5.seller_trx_event_id").as("seller_trx_event_id"),
          col("in5.is_unit_of_trx").as("is_unit_of_trx"),
          col("in5.revenue_auction_event_type").as("revenue_auction_event_type"),
          col("in5.is_prebid").as("is_prebid"),
          col("in5.auction_timestamp").as("auction_timestamp"),
          col("in5.two_phase_reduction_applied")
            .as("two_phase_reduction_applied"),
          col("in5.region_id").as("region_id"),
          col("in5.media_company_id").as("media_company_id"),
          col("in5.trade_agreement_id").as("trade_agreement_id"),
          col("in5.personal_data").as("personal_data"),
          col("in5.anonymized_user_info").as("anonymized_user_info"),
          col("in5.fx_rate_snapshot_id").as("fx_rate_snapshot_id"),
          col("in5.crossdevice_group_anon").as("crossdevice_group_anon"),
          col("in5.revenue_event_type_id").as("revenue_event_type_id"),
          col("in5.external_creative_id").as("external_creative_id"),
          col("in5.targeted_segment_details").as("targeted_segment_details"),
          col("in5.bidder_seat_id").as("bidder_seat_id"),
          col("in5.is_curated").as("is_curated"),
          col("in5.curator_member_id").as("curator_member_id"),
          col("in5.cold_start_price_type").as("cold_start_price_type"),
          col("in5.discovery_state").as("discovery_state"),
          col("in5.billing_period_id").as("billing_period_id"),
          col("in5.flight_id").as("flight_id"),
          col("in5.split_id").as("split_id"),
          col("in5.discovery_prediction").as("discovery_prediction"),
          col("in5.campaign_group_type_id").as("campaign_group_type_id"),
          col("in5.excluded_targeted_segment_details")
            .as("excluded_targeted_segment_details"),
          col("in5.predicted_kpi_event_rate").as("predicted_kpi_event_rate"),
          col("in5.has_crossdevice_reach_extension")
            .as("has_crossdevice_reach_extension"),
          col("in5.counterparty_ruleset_type").as("counterparty_ruleset_type"),
          col("in5.log_product_ads").as("log_product_ads"),
          col("in5.hb_source").as("hb_source"),
          col("in5.buyer_line_item_currency").as("buyer_line_item_currency"),
          col("in5.deal_line_item_currency").as("deal_line_item_currency"),
          col("in5.personal_identifiers_experimental")
            .as("personal_identifiers_experimental"),
          col("in5.postal_code_ext_id").as("postal_code_ext_id"),
          col("in5.targeted_segment_details_by_id_type")
            .as("targeted_segment_details_by_id_type"),
          col("in5.personal_identifiers").as("personal_identifiers"),
          col("in5.buyer_dpvp_bitmap").as("buyer_dpvp_bitmap"),
          col("in5.seller_dpvp_bitmap").as("seller_dpvp_bitmap")
        )
      )
    }
    
    import org.apache.spark.storage.StorageLevel
    
    // Persist the DataFrame to disk only
    in0.persist(StorageLevel.DISK_ONLY)
    
    import org.apache.spark.sql.Row
    
    in0.foreachPartition { (_: Iterator[Row]) => () }
    
    val out0 = in0
      .as("in0")
      .join(
        org.apache.spark.sql.functions.broadcast(in3).as("in3"),
        col("in0.auction_id_64") === col("in3.auction_id_64"),
        "left_outer"
      )
      .join(
        org.apache.spark.sql.functions.broadcast(in4).as("in4"),
        col("in0.auction_id_64") === col("in4.auction_id_64"),
        "left_outer"
      )
      .join(
        org.apache.spark.sql.functions.broadcast(in5).as("in5"),
        col("in0.auction_id_64") === col("in5.auction_id_64"),
        "left_outer"
      )
      .select(
        col("in0.auction_id_64").as("auction_id_64"),
        col("in0.date_time").as("date_time"),
        col("agg_platform_video_requests").as("agg_platform_video_requests"),
        col("agg_dw_video_events").as("agg_dw_video_events"),
        col("agg_platform_video_impressions")
          .as("agg_platform_video_impressions"),
        agg_dw_clicks().as("agg_dw_clicks"),
        agg_dw_pixels().as("agg_dw_pixels"),
        agg_impbus_clicks().as("agg_impbus_clicks")
      )
    out0
  }

}
