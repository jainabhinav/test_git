{"initCode":"","code":"udf( \n    (_l_filtered_terms: Seq[Row], _unfiltered_terms: Seq[Row], _i: Integer) => {\n      var l_current_term   = Row(null, null, null, null, null, null)\n      var l_filtered_terms = _l_filtered_terms.toArray\n      var i                = _i\n      var unfiltered_terms = _unfiltered_terms.toArray\n\n      while (compareTo(i, unfiltered_terms.length) < 0) {\n        l_current_term = unfiltered_terms(convertToInt(i))\n        if (\n          unfiltered_terms(convertToInt(i))\n            .getAs[Boolean](\"is_deduction\") == convertToBoolean(0)\n        )\n          l_filtered_terms =\n            Array.concat(l_filtered_terms,\n                         Array.fill(1)(unfiltered_terms(convertToInt(i)))\n            )\n        i = i + convertToInt(1)\n      }\n\n      Row(\n        if (!_isnull(l_current_term))\n          Row(\n            convertToInt(l_current_term.getAs[Integer](0)),\n            l_current_term.getAs[Double](1),\n            l_current_term.getAs[Double](2),\n            l_current_term.getAs[Boolean](3),\n            l_current_term.getAs[Boolean](4),\n            convertToInt(l_current_term.getAs[Integer](5))\n          )\n        else\n          null,\n        l_filtered_terms.map { x =>\n          if (!_isnull(x))\n            Row(convertToInt(x.getAs[Integer](0)),\n                x.getAs[Double](1),\n                x.getAs[Double](2),\n                x.getAs[Boolean](3),\n                x.getAs[Boolean](4),\n                convertToInt(x.getAs[Integer](5))\n            )\n          else\n            null\n        }.toArray,\n        convertToInt(i)\n      )\n    },\n    StructType(\n      List(\n        StructField(\n          \"l_current_term\",\n          StructType(\n            List(\n              StructField(\"term_id\",                 IntegerType, true),\n              StructField(\"amount\",                  DoubleType,  true),\n              StructField(\"rate\",                    DoubleType,  true),\n              StructField(\"is_deduction\",            BooleanType, true),\n              StructField(\"is_media_cost_dependent\", BooleanType, true),\n              StructField(\"data_member_id\",          IntegerType, true)\n            )\n          ),\n          false\n        ),\n        StructField(\n          \"l_filtered_terms\",\n          ArrayType(\n            StructType(\n              List(\n                StructField(\"term_id\",                 IntegerType, true),\n                StructField(\"amount\",                  DoubleType,  true),\n                StructField(\"rate\",                    DoubleType,  true),\n                StructField(\"is_deduction\",            BooleanType, true),\n                StructField(\"is_media_cost_dependent\", BooleanType, true),\n                StructField(\"data_member_id\",          IntegerType, true)\n              )\n            )\n          ),\n          false\n        ),\n        StructField(\"i\", IntegerType, false)\n      )\n    )\n  )"}