{"initCode":"","code":"udf( \n    ( \n      _l_data_costs:                Seq[Row],\n      _l_member_sales_tax_rate_pct: Double,\n      _i:                           Integer,\n      _l_data_cost:                 Row,\n      _data_costs:                  Seq[Row]\n    ) => {\n      var l_data_costs                = _l_data_costs.toArray\n      var l_member_sales_tax_rate_pct = _l_member_sales_tax_rate_pct\n      var i                           = _i\n      var l_data_cost                 = _l_data_cost\n      var data_costs                  = _data_costs.toArray\n\n      while (compareTo(i, data_costs.length) < 0) {\n        l_data_cost = data_costs(convertToInt(i))\n        if (!_isnull(data_costs(convertToInt(i))))\n          l_data_cost =\n            updateIndexInRow(l_data_cost,\n                             1,\n                             l_data_cost.getAs[Double](\n                               \"cost\"\n                             ) * (1.0 + (l_member_sales_tax_rate_pct / 100.0))\n            )\n        l_data_costs = Array.concat(l_data_costs, Array.fill(1)(l_data_cost))\n        i = i + convertToInt(1)\n      }\n\n      Row(\n        l_data_costs.map { x =>\n          if (!_isnull(x))\n            Row(convertToInt(x.getAs[Integer](0)),\n                x.getAs[Double](1),\n                x.getAs[Seq[Integer]](2).toArray,\n                x.getAs[Double](3)\n            )\n          else\n            null\n        }.toArray,\n        convertToInt(i),\n        if (!_isnull(l_data_cost))\n          Row(convertToInt(l_data_cost.getAs[Integer](0)),\n              l_data_cost.getAs[Double](1),\n              l_data_cost.getAs[Seq[Integer]](2).toArray,\n              l_data_cost.getAs[Double](3)\n          )\n        else\n          null\n      )\n    },\n    StructType(\n      List(\n        StructField(\n          \"l_data_costs\",\n          ArrayType(\n            StructType(\n              List(\n                StructField(\"data_member_id\", IntegerType,            true),\n                StructField(\"cost\",           DoubleType,             true),\n                StructField(\"used_segments\",  ArrayType(IntegerType), false),\n                StructField(\"cost_pct\",       DoubleType,             true)\n              )\n            )\n          ),\n          false\n        ),\n        StructField(\"i\", IntegerType, false),\n        StructField(\n          \"l_data_cost\",\n          StructType(\n            List(\n              StructField(\"data_member_id\", IntegerType,            true),\n              StructField(\"cost\",           DoubleType,             true),\n              StructField(\"used_segments\",  ArrayType(IntegerType), false),\n              StructField(\"cost_pct\",       DoubleType,             true)\n            )\n          ),\n          false\n        )\n      )\n    )\n  )"}