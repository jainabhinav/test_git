{"initCode":"","code":"udf( \n    (_id_type: Integer, _pi_list: Seq[Row], _i: Integer, _l_id_type: Integer) =>\n      {\n        var pi        = Row(convertToInt(0), null)\n        var l_id_type = _l_id_type\n        var id_type   = _id_type\n        var i         = _i\n        var pi_list   = _pi_list.toArray\n\n        while (compareTo(i, pi_list.length) < 0) {\n          l_id_type = 0\n          if (\n            !_isnull(pi_list(convertToInt(i)).getAs[Integer](\"identity_type\"))\n          )\n            l_id_type = convertToInt(\n              pi_list(convertToInt(i)).getAs[Integer](\"identity_type\")\n            )\n          if (l_id_type == id_type)\n            pi = pi_list(convertToInt(i))\n          i = i + convertToInt(1)\n        }\n        //val x = if(pi.isNullAt(1)) null else (pi.getAs[String](1)).toString;\n        //throw new RuntimeException(s\"pi is ${x}\");\n        Row(if (!_isnull(pi))\n              Row(convertToInt(pi.getAs[Integer](0)),\n                  if(pi.isNullAt(1)) null else (pi.getAs[String](1)).toString\n              )\n            else\n              null,\n            convertToInt(l_id_type),\n            convertToInt(i)\n        )\n      },\n    StructType(\n      List(\n        StructField(\"pi\",\n                    StructType(\n                      List(\n                        StructField(\"identity_type\",  IntegerType, true),\n                        StructField(\"identity_value\", StringType,  true)\n                      )\n                    ),\n                    true\n        ),\n        StructField(\"l_id_type\", IntegerType, true),\n        StructField(\"i\",         IntegerType, true)\n      )\n    )\n  )"}